/**
 * Cloudflare Worker: R2 Cloud Editor (TS Support Edition)
 * * ğŸ› ä¿®å¤: å½»åº•è§£å†³å¤§æ–‡ä»¶è§†é¢‘æ— æ³•æ’­æ”¾/æ— æ³•æ‹–åŠ¨çš„é—®é¢˜ (Backend Range Support)
 * * âš¡ ä¼˜åŒ–: æ··åˆæ’­æ”¾ç­–ç•¥ (300MBä»¥ä¸‹å†…å­˜åŠ è½½ï¼Œ300MBä»¥ä¸Šæµå¼åŠ è½½)
 * * ğŸ¥ æ–°å¢: å®Œç¾æ”¯æŒ .ts è§†é¢‘æ–‡ä»¶æµå¼æ’­æ”¾ (é›†æˆ mpegts.js)
 * * ğŸ¨ ç•Œé¢: ä¿æŒåŸæœ‰çš„ Glassmorphism é£æ ¼
 */

/**
 * Cloudflare Worker: R2 Cloud Editor (Ultimate Version)
 * * ğŸ”§ Fixed: è§£å†³æµè§ˆå™¨ç¼“å­˜å¯¼è‡´ä¿å­˜åçœ‹ä¸åˆ°ä¿®æ”¹çš„é—®é¢˜ (v=timestamp)
 * * ğŸ”§ Fixed: å¢å¼ºè‡ªåŠ¨ä¿å­˜é€»è¾‘ (åˆ‡æ¢æ–‡ä»¶/æ–‡ä»¶å¤¹/è¿”å›æ—¶è‡ªåŠ¨è§¦å‘)
 * * ğŸ’… UI: æŒ‰é’®äº¤äº’åé¦ˆ (å¤åˆ¶æˆåŠŸæ‰“é’©ã€ä¸‹è½½åŠ è½½åŠ¨ç”»)
 * * ğŸ’… UI: å…¨æ–°è®¾è®¡çš„è­¦ç¤ºé£æ ¼åˆ é™¤ç¡®è®¤å¼¹çª—
 */

// --- 1. å‰ç«¯éƒ¨åˆ† (HTML + CSS + UI Logic) ---
const htmlParts = [
  '<!DOCTYPE html>',
  '<html lang="zh-CN">',
  '<head>',
  '  <meta charset="UTF-8">',
  '  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">',
  '  <title>LifeVibe</title>',
  '  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜ï¸</text></svg>">',
  '  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">',
  '  ',
  '  ',
  '  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>',
  '  ',
  '  <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.min.js"></script>',
  '  <style>',
  '    :root {',
  '      --bg-glass: rgba(30, 30, 30, 0.75);',
  '      --bg-glass-lighter: rgba(255, 255, 255, 0.05);',
  '      --bg-glass-sidebar: rgba(20, 20, 20, 0.85);',
  '      --border-glass: rgba(255, 255, 255, 0.1);',
  '      --text-primary: #e0e0e0;',
  '      --text-secondary: #a0a0a0;',
  '      --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);',
  '      --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #c0392b 100%);',
  '      --accent-color: #667eea;',
  '      --danger-color: #ff6b6b;',
  '      --folder-color: #fbd38d;',
  '    }',
  '    ',
  '    body {',
  '      margin: 0;',
  '      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;',
  '      background: url("https://img.1766666.xyz/file/1772075773783_f1d01d71f46546b4b3d156ff8d0a2138.png") no-repeat center center fixed;',
  '      background-size: cover;',
  '      height: 100vh;',
  '      overflow: hidden;',
  '      display: flex;',
  '      justify-content: center;',
  '      align-items: center;',
  '      color: var(--text-primary);',
  '      transition: background-image 0.5s ease-in-out;',
  '    }',
  '',
  '    #app-container {',
  '      width: 96%;',
  '      height: 95vh;',
  '      max-width: none;',
  '      background: var(--bg-glass);',
  '      backdrop-filter: blur(20px);',
  '      -webkit-backdrop-filter: blur(20px);',
  '      border-radius: 16px;',
  '      border: 1px solid var(--border-glass);',
  '      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);',
  '      display: flex;',
  '      overflow: hidden;',
  '      transition: transform 0.3s ease;',
  '      position: relative;',
  '    }',
  '',
  '    /* --- ä¾§è¾¹æ  --- */',
  '    #sidebar {',
  '      width: 360px;',
  '      min-width: 240px;',
  '      max-width: 600px;',
  '      background: var(--bg-glass-sidebar);',
  '      border-right: 1px solid var(--border-glass);',
  '      display: flex;',
  '      flex-direction: column;',
  '      flex-shrink: 0;',
  '      position: relative;',
  '      transition: background 0.3s;',
  '      z-index: 100;',
  '    }',
  '    ',
  '    .resizer {',
  '      width: 5px;',
  '      cursor: col-resize;',
  '      position: absolute;',
  '      top: 0; bottom: 0; right: 0;',
  '      z-index: 101;',
  '      transition: background 0.2s;',
  '    }',
  '    .resizer:hover, .resizer.resizing { background: var(--accent-color); }',
  '    ',
  '    #sidebar.drag-active {',
  '        background: rgba(102, 126, 234, 0.15);',
  '        box-shadow: inset 0 0 20px rgba(102, 126, 234, 0.3);',
  '        border-right: 2px dashed var(--accent-color);',
  '    }',
  '    #sidebar.drag-active::after {',
  '        content: "ğŸ’­ ä¸Šå‚³åˆ°ç•¶å‰ç›®éŒ„";',
  '        position: absolute;',
  '        top: 50%; left: 50%; transform: translate(-50%, -50%);',
  '        color: #fff; font-weight: bold; font-size: 16px;',
  '        pointer-events: none; text-align: center;',
  '        background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 8px; z-index: 50;',
  '    }',
  '',
  '    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-glass); }',
  '    #mobile-menu-btn, #mobile-back-btn { display: none; }',
  '',
  '    .logo-area { font-size: 18px; font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; color: #fff; letter-spacing: 0.5px; }',
  '',
  '    .header-actions { display: flex; gap: 4px; width: 100%; box-sizing: border-box; flex-wrap: wrap; }',
  '    .glass-btn {',
  '      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary);',
  '      padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.2s;',
  '      display: flex; align-items: center; justify-content: center; gap: 5px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;',
  '      min-width: 60px;',
  '    }',
  '    .glass-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); border-color: rgba(255,255,255,0.2); }',
  '    .glass-btn:active { transform: scale(0.98); }',
  '    .btn-icon { flex: 0 0 32px; padding: 0; }',
  '',
  '    /* --- æ–°å¢: æŒ‰é’®äº¤äº’åé¦ˆåŠ¨ç”» --- */',
  '    @keyframes pulse-glass {',
  '        0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }',
  '        70% { box-shadow: 0 0 0 6px rgba(102, 126, 234, 0); }',
  '        100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }',
  '    }',
  '    .btn-loading { animation: pulse-glass 1.5s infinite; color: var(--accent-color) !important; pointer-events: none; }',
  '    .btn-success { color: #4cd964 !important; transform: scale(1.1); }',
  '',
  '    .path-bar { margin-top: 15px; font-family: monospace; font-size: 12px; color: var(--text-secondary); background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; white-space: nowrap; overflow-x: auto; }',
  '    .path-bar::-webkit-scrollbar { height: 2px; } .path-bar::-webkit-scrollbar-thumb { background: var(--accent-color); }',
  '    #file-list { flex: 1; overflow-y: auto; padding: 10px; }',
  '    #file-list::-webkit-scrollbar { width: 4px; } #file-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }',
  '',
  '    .file-item { padding: 5px 8px; margin-bottom: 2px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 13px; transition: all 0.2s; border: 1px solid transparent; }',
  '    .file-item:hover { background: var(--bg-glass-lighter); border-color: rgba(255,255,255,0.05); }',
  '    .file-item.active { background: rgba(102, 126, 234, 0.15); border-color: rgba(102, 126, 234, 0.3); color: #fff; }',
  '    .file-item.drag-target-hover { background: rgba(102, 126, 234, 0.3) !important; border: 1px dashed var(--accent-color) !important; box-shadow: 0 0 10px rgba(102, 126, 234, 0.2); }',
  '',
  '    .file-name-container { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; min-width: 0; }',
  '    .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }',
  '    .folder-icon { color: var(--folder-color); font-size: 16px; } .file-icon { opacity: 0.8; font-size: 16px; }',
  '    .actions { opacity: 0; transition: opacity 0.2s; display: flex; gap: 0px; } .file-item:hover .actions { opacity: 1; }',
  '    .icon-btn { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 2px 4px; border-radius: 4px; transition: color 0.2s; font-size: 12px; }',
  '    .icon-btn:hover { color: #fff; background: rgba(255,255,255,0.1); } .del-btn:hover { color: var(--danger-color); }',
  '    .move-btn:hover { color: var(--accent-color); } .rename-btn:hover { color: #4faaff; }',
  '',
  '    /* --- ä¸Šä¸‹æ–‡èœå• --- */',
  '    .context-menu {',
  '        display: none; position: absolute; z-index: 2000;',
  '        background: rgba(40, 40, 40, 0.95);',
  '        border: 1px solid var(--border-glass);',
  '        border-radius: 8px; padding: 6px 0;',
  '        width: 160px; max-height: 80vh; overflow-y: auto;',
  '        box-shadow: 0 10px 30px rgba(0,0,0,0.5);',
  '        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);',
  '    }',
  '    .context-menu::-webkit-scrollbar { width: 4px; }',
  '    .context-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }',
  '    .menu-item { padding: 8px 16px; cursor: pointer; color: #eee; font-size: 13px; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }',
  '    .menu-item:hover { background: var(--accent-color); color: #fff; }',
  '    .menu-item.disabled { opacity: 0.5; cursor: not-allowed; }',
  '    .menu-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }',
  '',
  '    /* --- ä¸»ç¼–è¾‘åŒº --- */',
  '    #main { flex: 1; display: flex; flex-direction: column; background: transparent; overflow: hidden; position: relative; }',
  '    .toolbar { padding: 15px 20px; border-bottom: 1px solid var(--border-glass); display: flex; gap: 15px; align-items: center; }',
  '    .toolbar-input { background: rgba(0,0,0,0.2); border: 1px solid var(--border-glass); color: #fff; padding: 8px 12px; border-radius: 8px; width: 300px; outline: none; font-size: 14px; transition: border-color 0.3s; }',
  '    .toolbar-input:focus { border-color: var(--accent-color); }',
  '    button.primary { background: var(--accent-gradient); color: white; border: none; padding: 8px 20px; border-radius: 50px; font-weight: 500; cursor: pointer; font-size: 13px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s; }',
  '    button.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }',
  '    button.primary:active { transform: translateY(0); }',
  '    button.primary.danger-btn { background: var(--danger-gradient); box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3); }',
  '    button.primary.danger-btn:hover { box-shadow: 0 6px 25px rgba(255, 107, 107, 0.5); }',
  '    #editor { flex: 1; background: transparent; color: #d4d4d4; border: none; padding: 25px; font-family: "Consolas", "Monaco", monospace; font-size: 14px; resize: none; outline: none; line-height: 1.6; }',
  '    #editor::placeholder { color: rgba(255,255,255,0.2); }',
  '    #editor:disabled { opacity: 0.6; cursor: not-allowed; color: #ff6b6b; font-weight: bold; }',
  '    #status { font-size: 12px; color: var(--text-secondary); opacity: 0.8; }',
  '    .rename-input { background: rgba(0,0,0,0.3); border: 1px solid var(--accent-color); color: white; border-radius: 4px; padding: 2px 5px; width: 90%; }',
  '',
  '    /* --- åª’ä½“é¢„è§ˆå®¹å™¨é€šç”¨ --- */',
  '    .preview-container { display: none; flex: 1; justify-content: center; align-items: center; overflow: hidden; background: rgba(0,0,0,0.1); padding: 20px; flex-direction: column; position: relative; box-sizing: border-box; }',
  '    ',
  '    /* å›¾ç‰‡é¢„è§ˆ */',
  '    #image-preview img { max-width: 95%; max-height: 95%; object-fit: contain; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 8px; animation: zoomIn 0.3s ease; }',
  '    ',
  '    /* è§†é¢‘é¢„è§ˆ (Native) */',
  '    #video-preview { position: relative; width: 100%; height: 100%; background: #000; padding: 0; }',
  '    #video-preview video { width: 100%; height: 100%; object-fit: contain; outline: none; }',
  '',
  '    @keyframes zoomIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }',
  '',
  '    /* --- æ— é¢„è§ˆ/å¤§æ–‡ä»¶å¡ç‰‡è§†å›¾ --- */',
  '    .file-info-card {',
  '        background: rgba(30, 30, 30, 0.6);',
  '        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);',
  '        border: 1px solid var(--border-glass); border-radius: 16px;',
  '        padding: 40px; display: flex; flex-direction: column; align-items: center;',
  '        text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.4);',
  '        max-width: 360px; animation: slideUp 0.3s ease-out;',
  '    }',
  '    .info-icon-large { font-size: 64px; margin-bottom: 15px; display: block; }',
  '    .info-filename { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 5px; word-break: break-all; }',
  '    .info-meta { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; font-family: monospace; }',
  '    .warning-text {',
  '        font-size: 13px; color: #ffcece; background: rgba(200, 50, 50, 0.2);',
  '        border: 1px solid rgba(255, 100, 100, 0.2); padding: 8px 12px; border-radius: 6px;',
  '        margin-bottom: 20px; width: 100%; box-sizing: border-box;',
  '    }',
  '',
  '    /* --- è‡ªå®šä¹‰éŸ³é¢‘æ’­æ”¾å™¨æ ·å¼ --- */',
  '    #custom-audio-player {',
  '        display: none; flex-direction: column; align-items: center; justify-content: center;',
  '        width: 320px; padding: 30px;',
  '        background: rgba(20, 20, 20, 0.7);',
  '        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);',
  '        border: 1px solid var(--border-glass);',
  '        border-radius: 20px;',
  '        box-shadow: 0 20px 50px rgba(0,0,0,0.5);',
  '        animation: slideUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);',
  '    }',
  '    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }',
  '    .audio-art {',
  '        width: 120px; height: 120px; border-radius: 50%;',
  '        background: var(--accent-gradient);',
  '        display: flex; justify-content: center; align-items: center;',
  '        font-size: 50px; margin-bottom: 20px;',
  '        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);',
  '        animation: spin 10s linear infinite; animation-play-state: paused;',
  '    }',
  '    .audio-art.playing { animation-play-state: running; }',
  '    @keyframes spin { 100% { transform: rotate(360deg); } }',
  '    .audio-info { text-align: center; margin-bottom: 20px; width: 100%; }',
  '    .audio-title { font-size: 16px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }',
  '    .audio-subtitle { font-size: 12px; color: var(--text-secondary); margin-top: 5px; display: block; }',
  '    .audio-controls-row { display: flex; align-items: center; gap: 20px; width: 100%; justify-content: center; }',
  '    .play-pause-btn {',
  '        width: 50px; height: 50px; border-radius: 50%; border: none;',
  '        background: #fff; color: var(--accent-color); font-size: 20px;',
  '        display: flex; justify-content: center; align-items: center;',
  '        cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 15px rgba(255,255,255,0.2);',
  '    }',
  '    .play-pause-btn:hover { transform: scale(1.1); }',
  '    .play-pause-btn:active { transform: scale(0.95); }',
  '    .audio-progress-container { width: 100%; margin-bottom: 15px; }',
  '    .time-row { display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-top: 5px; font-family: monospace; }',
  '    ',
  '    /* è‡ªå®šä¹‰ Range Slider é€šç”¨ */',
  '    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }',
  '    input[type=range]:focus { outline: none; }',
  '    input[type=range]::-webkit-slider-runnable-track {',
  '        width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;',
  '    }',
  '    input[type=range]::-webkit-slider-thumb {',
  '        height: 12px; width: 12px; border-radius: 50%; background: #fff;',
  '        -webkit-appearance: none; margin-top: -4px; box-shadow: 0 0 10px rgba(255,255,255,0.5);',
  '        transition: transform 0.1s;',
  '    }',
  '    input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.3); }',
  '',
  '    /* --- Toast Notifications (Glassy) --- */',
  '    #toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 4000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: auto; align-items: center; }',
  '    .toast { background: rgba(40, 40, 40, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); padding: 10px 24px; border-radius: 50px; color: #fff; font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); opacity: 0; transform: translateY(-20px); transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); display: flex; align-items: center; gap: 8px; pointer-events: auto; }',
  '    .toast.show { opacity: 1; transform: translateY(0); }',
  '    .toast.error { border-color: rgba(255, 107, 107, 0.4); color: #ffcece; background: rgba(50, 20, 20, 0.9); }',
  '',
  '    /* --- ä¸Šä¼ è¿›åº¦æ‚¬æµ®çª— (å³ä¸Šè§’) --- */',
  '    #upload-progress-container {',
  '        position: fixed; top: 20px; right: 20px; width: 320px; z-index: 3000;',
  '        display: flex; flex-direction: column; gap: 10px;',
  '    }',
  '    .progress-card {',
  '        background: rgba(20, 20, 20, 0.9); border: 1px solid var(--border-glass);',
  '        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);',
  '        border-radius: 8px; padding: 12px; color: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.5);',
  '        animation: slideIn 0.3s ease-out;',
  '    }',
  '    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }',
  '    .progress-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }',
  '    .progress-filename { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }',
  '    .progress-bar-bg { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }',
  '    .progress-bar-fill { height: 100%; background: var(--accent-gradient); width: 0%; transition: width 0.2s; }',
  '    .progress-details { display: flex; justify-content: space-between; font-size: 10px; color: #aaa; margin-top: 4px; }',
  '',
  '    /* --- æ¨¡æ€æ¡†é€šç”¨ --- */',
  '    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center; transition: opacity 0.3s; }',
  '    .modal-box { background: rgba(30, 30, 30, 0.95); border: 1px solid var(--border-glass); width: 450px; max-width: 90%; border-radius: 20px; box-shadow: 0 25px 60px rgba(0,0,0,0.6); overflow: hidden; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center center; display: flex; flex-direction: column; }',
  '    @keyframes fadeIn { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }',
  '    .modal-header { padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #fff; font-size: 16px; background: rgba(255,255,255,0.02); }',
  '    .modal-body { padding: 25px; font-size: 14px; color: #ccc; line-height: 1.6; overflow-y: auto; max-height: 70vh; }',
  '    .modal-footer { padding: 20px 25px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: flex-end; gap: 12px; background: rgba(0,0,0,0.1); }',
  '    .modal-close { cursor: pointer; opacity: 0.5; transition: 0.2s; font-size: 18px; width: 30px; height: 30px; display: flex; justify-content: center; align-items: center; border-radius: 50%; } ',
  '    .modal-close:hover { opacity: 1; background: rgba(255,255,255,0.1); }',
  '',
  '    /* --- ä¼˜åŒ–: åˆ é™¤ç¡®è®¤å¼¹çª— (Confirm Modal) --- */',
  '    .confirm-icon-box {',
  '        width: 80px; height: 80px;',
  '        background: rgba(255, 107, 107, 0.1);',
  '        border-radius: 50%;',
  '        display: flex; justify-content: center; align-items: center;',
  '        margin: 0 auto 20px auto;',
  '        border: 1px solid rgba(255, 107, 107, 0.2);',
  '        animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);',
  '    }',
  '    .confirm-icon { font-size: 40px; }',
  '    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }',
  '    .confirm-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 8px; }',
  '    .confirm-desc { font-size: 14px; color: #aaa; margin-bottom: 25px; line-height: 1.5; padding: 0 20px; }',
  '    .confirm-file-highlight { ',
  '        color: #ffcece; background: rgba(255, 107, 107, 0.15); ',
  '        padding: 2px 6px; border-radius: 4px; font-family: monospace; ',
  '        border: 1px solid rgba(255, 107, 107, 0.2);',
  '    }',
  '',
  '    /* --- ä¼˜åŒ–çš„ä¿¡æ¯å¼¹çª—æ ·å¼ --- */',
  '    .info-list { display: flex; flex-direction: column; gap: 10px; }',
  '    .info-card-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); transition: background 0.2s; }',
  '    .info-card-item:hover { background: rgba(255,255,255,0.05); }',
  '    .info-label { color: #aaa; font-size: 12px; display: flex; align-items: center; gap: 6px; }',
  '    .info-value { color: #fff; font-family: "Monaco", "Consolas", monospace; font-size: 13px; text-align: right; user-select: text; max-width: 60%; word-break: break-all; }',
  '    .copy-mini-btn { padding: 2px 6px; font-size: 10px; margin-left: 5px; opacity: 0.6; }',
  '    ',
  '    .full-width-input { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-glass); background: rgba(0,0,0,0.3); color: #fff; outline: none; transition: border-color 0.3s; font-size: 14px; margin-bottom: 10px; }',
  '    .full-width-input:focus { border-color: var(--accent-color); }',
  '    .folder-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-glass); background: rgba(30,30,30,0.8); color: #eee; outline: none; margin-bottom: 15px; }',
  '',
  '    .login-box { width: 380px; text-align: center; }',
  '    .login-title { font-size: 20px; margin-bottom: 20px; display: block; font-weight: bold; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }',
  '    .login-input-group { margin-bottom: 15px; text-align: left; }',
  '    .login-input { width: 100%; padding: 12px; box-sizing: border-box; border-radius: 8px; border: 1px solid var(--border-glass); background: rgba(0,0,0,0.3); color: #fff; outline: none; transition: border-color 0.3s; font-size: 14px; }',
  '    .login-input:focus { border-color: var(--accent-color); }',
  '    .login-btn { width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; }',
  '',
  '    /* --- ç§»åŠ¨ç«¯ --- */',
  '    @media (max-width: 768px) {',
  '      #app-container { width: 94%; height: 92vh; border-radius: 16px; border: 1px solid var(--border-glass); flex-direction: column; overflow: hidden; }',
  '      .resizer { display: none; }',
  '      #sidebar { width: 100%; height: 100%; max-width: none; background-color: #181818 !important; backdrop-filter: none !important; border-right: none; }',
  '      #main { display: none; width: 100%; height: 100%; }',
  '      body.mobile-mode-editor #sidebar { display: none; }',
  '      body.mobile-mode-editor #main { display: flex; z-index: 20; background: #121212; }',
  '      #mobile-menu-btn { display: none; } #sidebar-close-btn { display: none; } #mobile-back-btn { display: block; background: transparent; border: 1px solid var(--border-glass); color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-right: 8px; font-size: 16px; }',
  '      .toolbar { padding: 10px; gap: 8px; } .toolbar-input { width: 100%; flex: 1; } .primary { flex: none; padding: 6px 12px; font-size: 12px; } #status { display: none; }',
  '      .actions { opacity: 1; gap: 0px; margin-left: 5px; } .file-item { padding: 10px 6px; } .icon-btn { padding: 6px 4px; font-size: 14px; }',
  '      #upload-progress-container { width: 90%; left: 5%; right: 5%; top: 10px; }',
  '    }',
  '  </style>',
  '</head>',
  '<body>',
  '  ',
  '  <div id="toast-container"></div>',
  '  <div id="upload-progress-container"></div>',
  '',
  '  <div id="app-container">',
  '    <div id="sidebar">',
  '      <div class="sidebar-header">',
  '        <div class="logo-area"><span>ğŸ’­ é›²ç›¤</span></div>',
  '        <div class="header-actions">',
  '           <button class="glass-btn" onclick="triggerFileUpload()" title="ä¸Šå‚³æ–‡ä»¶">ğŸ’­ ä¸Šå‚³æ–‡ä»¶</button>',
  '           <button class="glass-btn" onclick="handleSidebarNewFile()">ğŸ’­ æ–°å»ºæ–‡ä»¶</button>',
  '           <button class="glass-btn" onclick="createEntry(\'folder\')">ğŸ’­ æ–°å»ºæ–‡ä»¶å¤¹</button>',
  '           <button class="glass-btn btn-icon" onclick="reloadList()" title="åˆ·æ–°">ğŸ¼</button>',
  '           <input type="file" id="hidden-file-input" multiple style="display:none">',
  '        </div>',
  '        <div class="path-bar" id="current-path-display">Connecting...</div>',
  '      </div>',
  '      <div id="file-list"></div>',
  '      <div id="sidebar-resizer" class="resizer"></div>',
  '    </div>',
  '    <div id="main">',
  '      <div class="toolbar">',
  '        <button id="mobile-back-btn" onclick="showMobileSidebar()">â¬…</button>',
  '        <input type="text" id="filename-input" class="toolbar-input" placeholder="è¾“å…¥æ–‡ä»¶å...">',
  '        <button class="primary" onclick="prepareNewFile()">ğŸ’­æ–°å»ºæ–‡ä»¶</button>',
  '        <button class="primary" onclick="saveEditorContent()">ğŸ’­ä¿å­˜æ–‡ä»¶</button>',
  '        <button class="primary" onclick="triggerCloudDL()">ğŸ’­ äº‘ä¸‹è½½</button>',
  '        <div style="margin-left: auto; display: flex; align-items: center; gap: 6px;">',
  '              <span id="status">Ready</span>',
  '              <button onclick="toggleBg()" style="background:transparent; border:none; color:rgba(255,255,255,0.3); cursor:pointer; font-size:18px; padding:0; display:flex; align-items:center;" title="åˆ‡æ¢èƒŒæ™¯">ğŸ¨</button>',
  '        </div>',
  '      </div>',
  '      <textarea id="editor" placeholder="// Select a file..."></textarea>',
  '      <div id="image-preview" class="preview-container"><img src="" alt="Preview"></div>',
  '      <div id="video-preview" class="preview-container">',
  '          <video id="main-video" controls playsinline preload="metadata"></video>',
  '      </div>',
  '      ',
  '      ',
  '      <div id="audio-preview" class="preview-container">',
  '          <div id="custom-audio-player">',
  '              <div class="audio-art" id="audio-art-icon">ğŸ¶</div>',
  '              <div class="audio-info">',
  '                  <span class="audio-title" id="player-title">Unknown Track</span>',
  '                  <span class="audio-subtitle">Audio Preview</span>',
  '              </div>',
  '              <div class="audio-progress-container">',
  '                  <input type="range" id="audio-seek-slider" min="0" max="100" value="0">',
  '                  <div class="time-row">',
  '                      <span id="audio-current-time">00:00</span>',
  '                      <span id="audio-duration">00:00</span>',
  '                  </div>',
  '              </div>',
  '              <div class="audio-controls-row">',
  '                  <button class="play-pause-btn" id="audio-play-btn" onclick="toggleAudio()">â¯</button>',
  '              </div>',
  '          </div>',
  '          <audio id="hidden-audio" style="display:none;"></audio>',
  '      </div>',
  '',
  '      ',
  '      <div id="no-preview-view" class="preview-container">',
  '          <div class="file-info-card">',
  '              <span class="info-icon-large" id="np-icon">ğŸ“„</span>',
  '              <span class="info-filename" id="np-filename">Filename.ext</span>',
  '              <span class="info-meta" id="np-meta">0 KB | Unknown Type</span>',
  '              <span class="warning-text" id="np-warning">â• æ­¤æ–‡ä»¶ä¸æ”¯æŒåœ¨ç·šé è¦½æˆ–åŒ…å«äºŒé€²åˆ¶å…§å®¹</span>',
  '              <div style="display:flex; flex-direction:column; gap:10px; width:100%;">',
  '                    <button class="primary" id="np-download-btn" style="width:100%;">âš¡ï¸ ä¸‹è¼‰æ–‡ä»¶</button>',
  '                    <button class="glass-btn" id="np-force-edit-btn" style="width:100%; font-size:12px; color:#aaa;">ğŸ–Šå¼·è¡Œç·¨è¼¯ (æ–‡æœ¬)</button>',
  '              </div>',
  '          </div>',
  '      </div>',
  '',
  '    </div>',
  '  </div>',
  '',
  '  <div id="context-menu" class="context-menu">',
  '      <div class="menu-item" onclick="execMenu(\'open\')">ğŸ’­ æ‰“é–‹</div>',
  '      <div class="menu-item" onclick="execMenu(\'share\')">ğŸ’­ åœ¨ç¶«ç€è¦½ğŸ…åˆ†äº«</div>',
  '      <div class="menu-separator"></div>',
  '      <div class="menu-item" onclick="execMenu(\'rename\')">ğŸ—„ é‡å‘½å</div>',
  '      <div class="menu-item" onclick="execMenu(\'cut\')">ğŸ—„ å‰ªåˆ‡</div>',
  '      <div class="menu-item" onclick="execMenu(\'copy\')">ğŸ—„ è¤‡è£½</div>',
  '      <div class="menu-item" id="menu-paste" onclick="execMenu(\'paste\')">ğŸ—„ ç²˜è²¼</div>',
  '      <div class="menu-separator"></div>',
  '      <div class="menu-item" onclick="execMenu(\'move\')">ğŸ—„ ç§»å‹•</div>',
  '      <div class="menu-item" onclick="execMenu(\'copy_link\')">ğŸ—„ è¤‡è£½éˆæ¥</div>',
  '      <div class="menu-item" onclick="execMenu(\'download\')">ğŸ—„ ä¸‹è¼‰</div>',
  '      <div class="menu-separator"></div>',
  '      <div class="menu-item" onclick="execMenu(\'info\')">â• å±¬æ€§</div>',
  '      <div class="menu-item" onclick="execMenu(\'delete\')" style="color:var(--danger-color)">ğŸ—‘ åˆªé™¤</div>',
  '  </div>',
  '',
  '  <div id="login-modal" class="modal-overlay" style="display: flex;">',
  '    <div class="modal-box login-box">',
  '       <div class="modal-body" style="padding: 30px 25px;">',
  '           <span class="login-title">ç™»éŒ„</span>',
  '           <div class="login-input-group"><input type="text" id="login-user" class="login-input" placeholder="è¼¸å…¥ç”¨æˆ¶å" autocomplete="username"></div>',
  '           <div class="login-input-group"><input type="password" id="login-pass" class="login-input" placeholder="è¾“å…¥å¯†ç " autocomplete="current-password"></div>',
  '           <button class="primary login-btn" onclick="performLogin()">ç™»éŒ„</button>',
  '       </div>',
  '    </div>',
  '  </div>',
  '',
  '  <div id="move-modal" class="modal-overlay">',
  '    <div class="modal-box">',
  '       <div class="modal-header"><span id="move-title">ç§»å‹•æ–‡ä»¶</span><span class="modal-close" onclick="closeModal(\'move-modal\')">âœ•</span></div>',
  '       <div class="modal-body">',
  '           <p style="color:#aaa; margin-bottom:5px; font-size:12px;">é¸æ“‡ç›®æ¨™æ–‡ä»¶å¤¹:</p>',
  '           <select id="move-folder-select" class="folder-select" onchange="updateMoveInput()"></select>',
  '           <p style="color:#aaa; margin-bottom:5px; font-size:12px;">ç›®æ¨™å®Œæ•´è·¯å¾‘ (å¯ç·¨è¼¯):</p>',
  '           <input type="text" id="move-input" class="full-width-input" spellcheck="false">',
  '       </div>',
  '       <div class="modal-footer">',
  '           <button class="glass-btn" onclick="closeModal(\'move-modal\')">å–æ¶ˆ</button>',
  '           <button class="primary" onclick="submitMove()">ç¢ºèªç§»å‹•</button>',
  '       </div>',
  '    </div>',
  '  </div>',
  '',
  '  ',
  '  <div id="cloud-dl-modal" class="modal-overlay">',
  '    <div class="modal-box">',
  '       <div class="modal-header"><span>ğŸ’­ é›²ä¸‹è¼‰ (é ç¨‹ä¸Šå‚³)</span><span class="modal-close" onclick="closeModal(\'cloud-dl-modal\')">âœ•</span></div>',
  '       <div class="modal-body">',
  '           <p style="color:#aaa; margin-bottom:5px; font-size:12px;">è¼¸å…¥æ–‡ä»¶ URL:</p>',
  '           <input type="text" id="cloud-dl-url" class="full-width-input" placeholder="https://example.com/file.zip" spellcheck="false">',
  '           <p style="color:#aaa; margin-bottom:5px; font-size:12px; margin-top:10px;">(æ–‡ä»¶å°‡ç›´æ¥ä¿å­˜ç•¶å‰ç›®éŒ„)</p>',
  '       </div>',
  '       <div class="modal-footer">',
  '           <button class="glass-btn" onclick="closeModal(\'cloud-dl-modal\')">å–æ¶ˆ</button>',
  '           <button class="primary" onclick="submitCloudDL()">é–‹å§‹ä¸‹è¼‰</button>',
  '       </div>',
  '    </div>',
  '  </div>',
  '',
  '  <div id="info-modal" class="modal-overlay">',
  '    <div class="modal-box">',
  '       <div class="modal-header"><span id="modal-title">Info</span><span class="modal-close" onclick="closeModal(\'info-modal\')">âœ•</span></div>',
  '       <div class="modal-body" id="modal-content">Loading...</div>',
  '    </div>',
  '  </div>',
  '',
  '  <div id="confirm-modal" class="modal-overlay">',
  '    <div class="modal-box">',
  '       ',
  '       <div class="modal-body" id="confirm-message" style="text-align: center; padding-top: 30px;"></div>',
  '       <div class="modal-footer" style="justify-content: center; padding-bottom: 30px; border-top: none;">',
  '           <button class="glass-btn" onclick="closeModal(\'confirm-modal\')" style="padding: 8px 24px; font-size:14px;">å–æ¶ˆ</button>',
  '           <button id="confirm-btn-ok" class="primary danger-btn" style="padding: 8px 30px; font-size:14px;">ç¢ºèªåˆªé™¤</button>',
  '       </div>',
  '    </div>',
  '  </div>',
  '',
  '  <script>',
  '    var currentPrefix = "";',
  '    var authToken = null;',
  '    var availableFolders = [];',
  '    var currentEditingKey = null;',
  '    var isUnsaved = false;',
  '    var editor = document.getElementById("editor");',
  '    var filenameInput = document.getElementById("filename-input");',
  '    var statusMsg = document.getElementById("status");',
  '    var pathDisplay = document.getElementById("current-path-display");',
  '    var sidebar = document.getElementById("sidebar");',
  '    var fileInput = document.getElementById("hidden-file-input");',
  '    var loginModal = document.getElementById("login-modal");',
  '    var contextMenu = document.getElementById("context-menu");',
  '    var isRenaming = false;',
  '    var isRenamingProcessing = false;',
  '    var targetMoveKey = null; var targetMoveIsFolder = false; var targetMoveName = "";',
  '    var clipboardAction = null; var clipboardSource = null; var clipboardIsFolder = false;',
  '    var ctxTargetKey = null; var ctxIsFolder = false; var ctxTargetEl = null;',
  '    var currentMediaUrl = null;',
  '    var hls = null; // HLS å®ä¾‹',
  '    var mpegtsPlayer = null; // mpegts å®ä¾‹',
  '    /* Audio Player Vars */',
  '    var audioEl = document.getElementById("hidden-audio");',
  '    var audioPlayBtn = document.getElementById("audio-play-btn");',
  '    var audioSeekSlider = document.getElementById("audio-seek-slider");',
  '    var audioCurrentTime = document.getElementById("audio-current-time");',
  '    var audioDuration = document.getElementById("audio-duration");',
  '    var audioArt = document.getElementById("audio-art-icon");',
  '',
  '    /* --- Toast Notification System --- */',
  '    function showToast(msg, type = "info") {',
  '        let container = document.getElementById("toast-container");',
  '        let el = document.createElement("div");',
  '        el.className = "toast " + (type === "error" ? "error" : "");',
  '        el.innerHTML = (type === "error" ? "âš ï¸ " : "â„¹ï¸ ") + msg;',
  '        container.appendChild(el);',
  '        void el.offsetWidth;',
  '        el.classList.add("show");',
  '        setTimeout(() => {',
  '            el.classList.remove("show");',
  '            setTimeout(() => el.remove(), 300);',
  '        }, 3000);',
  '    }',
  '',
  '    /* --- Audio Player Logic --- */',
  '    function toggleAudio() {',
  '        if (audioEl.paused) { audioEl.play(); } else { audioEl.pause(); }',
  '    }',
  '    function formatAudioTime(secs) {',
  '        var m = Math.floor(secs / 60);',
  '        var s = Math.floor(secs % 60);',
  '        return (m < 10 ? "0"+m : m) + ":" + (s < 10 ? "0"+s : s);',
  '    }',
  '    audioEl.addEventListener("play", () => { audioPlayBtn.innerHTML = "â¸"; audioArt.classList.add("playing"); });',
  '    audioEl.addEventListener("pause", () => { audioPlayBtn.innerHTML = "â–¶"; audioArt.classList.remove("playing"); });',
  '    audioEl.addEventListener("timeupdate", () => {',
  '        if(!audioEl.duration) return;',
  '        var pct = (audioEl.currentTime / audioEl.duration) * 100;',
  '        audioSeekSlider.value = pct;',
  '        audioCurrentTime.innerText = formatAudioTime(audioEl.currentTime);',
  '    }',
  '    );',
  '    audioEl.addEventListener("loadedmetadata", () => {',
  '        audioDuration.innerText = formatAudioTime(audioEl.duration);',
  '    });',
  '    audioSeekSlider.addEventListener("input", () => {',
  '        var time = (audioSeekSlider.value / 100) * audioEl.duration;',
  '        audioEl.currentTime = time;',
  '    });',
  '',
  '    /* --- Cloud Download Logic --- */',
  '    function triggerCloudDL() {',
  '        document.getElementById("cloud-dl-url").value = "";',
  '        document.getElementById("cloud-dl-modal").style.display = "flex";',
  '        document.getElementById("cloud-dl-url").focus();',
  '    }',
  '    async function submitCloudDL() {',
  '        var urlInput = document.getElementById("cloud-dl-url");',
  '        var url = urlInput.value.trim();',
  '        if (!url) return showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ URL", "error");',
  '        ',
  '        // ç®€å•çš„æ–‡ä»¶åæå–é€»è¾‘',
  '        var filename = "download_" + Date.now();',
  '        try {',
  '            var urlPath = new URL(url).pathname;',
  '            var extracted = urlPath.split("/").pop();',
  '            if (extracted && extracted.indexOf(".") !== -1) filename = extracted;',
  '        } catch(e) {}',
  '        ',
  '        var targetKey = currentPrefix + filename;',
  '        statusMsg.innerText = "Cloud Downloading...";',
  '        closeModal("cloud-dl-modal");',
  '        showToast("åå°ä¸‹è½½ä»»åŠ¡å·²å¼€å§‹...", "info");',
  '',
  '        try {',
  '            var res = await apiFetch("/api/cloud_download", {',
  '                method: "POST",',
  '                headers: { "Content-Type": "application/json" },',
  '                body: JSON.stringify({ fileUrl: url, targetKey: targetKey })',
  '            });',
  '            if (res.ok) {',
  '                showToast("ä¸‹è½½æˆåŠŸ: " + filename, "success");',
  '                reloadList();',
  '                statusMsg.innerText = "Done";',
  '            } else {',
  '                var txt = await res.text();',
  '                showToast("ä¸‹è½½å¤±è´¥: " + txt, "error");',
  '                statusMsg.innerText = "Error";',
  '            }',
  '        } catch (e) {',
  '            showToast("è¯·æ±‚å¤±è´¥: " + e.message, "error");',
  '        }',
  '    }',
  '',
  '    /* --- ä¾§è¾¹æ æ‹–æ‹½ --- */',
  '    var resizer = document.getElementById("sidebar-resizer");',
  '    var isResizingSidebar = false;',
  '    resizer.addEventListener("mousedown", function(e) {',
  '        isResizingSidebar = true; resizer.classList.add("resizing");',
  '        document.body.style.cursor = "col-resize"; document.body.style.userSelect = "none";',
  '        e.preventDefault();',
  '    });',
  '    document.addEventListener("mousemove", function(e) {',
  '        if (!isResizingSidebar) return;',
  '        var containerLeft = document.getElementById("app-container").getBoundingClientRect().left;',
  '        var newWidth = e.clientX - containerLeft;',
  '        if (newWidth > 240 && newWidth < 600) sidebar.style.width = newWidth + "px";',
  '    });',
  '    document.addEventListener("mouseup", function() {',
  '        if (isResizingSidebar) {',
  '            isResizingSidebar = false; resizer.classList.remove("resizing");',
  '            document.body.style.cursor = ""; document.body.style.userSelect = "";',
  '        }',
  '    });',
  '',
  '    var currentBgState = 0; ',
  '    const bg1 = "https://bing.img.run/rand_1366x768.php";',
  '    const bg2 = "https://gips0.baidu.com/it/u=2864904819,3156938601&fm=3074&app=3074&f=PNG?w=2560&h=1440";',
  '    function toggleBg() {',
  '        currentBgState = 1 - currentBgState;',
  '        var url = currentBgState === 0 ? bg1 : bg2;',
  '        document.body.style.backgroundImage = "url(\'" + url + "\')";',
  '    }',
  '',
  '    function showMobileEditor() { document.body.classList.add("mobile-mode-editor"); }',
  '    function showMobileSidebar() { document.body.classList.remove("mobile-mode-editor"); }',
  '',
  '    editor.addEventListener("input", function() { isUnsaved = true; statusMsg.innerText = "Editing..."; });',
  '',
  '    async function handleFilenameBlur() {',
  '        if (!currentEditingKey || isRenamingProcessing) return;',
  '        var newName = filenameInput.value.trim();',
  '        var oldName = currentEditingKey.split("/").pop();',
  '        if (!newName || newName === oldName) return;',
  '        isRenamingProcessing = true;',
  '        var newKey = currentPrefix + newName;',
  '        statusMsg.innerText = "Renaming...";',
  '        try {',
  '            var res = await apiFetch("/api/rename", { ',
  '                method: "POST", headers: {"Content-Type": "application/json"}, ',
  '                body: JSON.stringify({ oldKey: currentEditingKey, newKey: newKey, isFolder: false }) ',
  '            });',
  '            if (res.ok) {',
  '                statusMsg.innerText = "Renamed"; currentEditingKey = newKey; reloadList();',
  '            } else {',
  '                if(res.status !== 404) { showToast("é‡å‘½åå¤±è´¥", "error"); filenameInput.value = oldName; }',
  '            }',
  '        } catch(e) { console.error(e); filenameInput.value = oldName; }',
  '        finally { isRenamingProcessing = false; }',
  '    }',
  '    filenameInput.addEventListener("blur", handleFilenameBlur);',
  '    filenameInput.addEventListener("keydown", function(e) { if(e.key === "Enter") { this.blur(); editor.focus(); } });',
  '',
  '    (function initAuth() {',
  '        var savedToken = localStorage.getItem("r2_auth_token");',
  '        var savedTime = localStorage.getItem("r2_auth_time");',
  '        var now = new Date().getTime();',
  '        if (savedToken && savedTime && (now - savedTime < 7 * 24 * 60 * 60 * 1000)) {',
  '            authToken = savedToken; loginModal.style.display = "none"; loadList("");',
  '        } else {',
  '            localStorage.removeItem("r2_auth_token"); localStorage.removeItem("r2_auth_time"); showLoginModal();',
  '        }',
  '    })();',
  '',
  '    async function apiFetch(url, options = {}) {',
  '        if (!authToken) { showLoginModal(); throw new Error("Auth required"); }',
  '        if (!options.headers) options.headers = {};',
  '        options.headers["Authorization"] = "Basic " + authToken;',
  '        const response = await fetch(url, options);',
  '        if (response.status === 401) { authToken = null; showLoginModal(); throw new Error("Auth failed"); }',
  '        return response;',
  '    }',
  '    function showLoginModal() { loginModal.style.display = "flex"; document.getElementById("login-user").focus(); }',
  '    function performLogin() {',
  '        var user = document.getElementById("login-user").value;',
  '        var pass = document.getElementById("login-pass").value;',
  '        if (!user || !pass) return showToast("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ", "error");',
  '        authToken = btoa(user + ":" + pass);',
  '        localStorage.setItem("r2_auth_token", authToken); localStorage.setItem("r2_auth_time", new Date().getTime());',
  '        loginModal.style.display = "none"; loadList("");',
  '    }',
  '    document.getElementById("login-pass").addEventListener("keypress", function(e) { if (e.key === "Enter") performLogin(); });',
  '',
  '    function showContextMenu(e, key, isFolder, element) {',
  '        e.preventDefault();',
  '        ctxTargetKey = key; ctxIsFolder = isFolder; ctxTargetEl = element;',
  '        var pasteBtn = document.getElementById("menu-paste");',
  '        if(clipboardAction) pasteBtn.classList.remove("disabled");',
  '        else pasteBtn.classList.add("disabled");',
  '        contextMenu.style.display = "block";',
  '        var menuWidth = contextMenu.offsetWidth; var menuHeight = contextMenu.offsetHeight;',
  '        var winWidth = window.innerWidth; var winHeight = window.innerHeight;',
  '        var x = e.pageX; var y = e.pageY;',
  '        if (x + menuWidth > winWidth) { x = winWidth - menuWidth - 10; }',
  '        if (y + menuHeight > winHeight) { y = y - menuHeight; }',
  '        if (y < 0) { y = 0; }',
  '        contextMenu.style.left = x + "px"; contextMenu.style.top = y + "px";',
  '    }',
  '    window.addEventListener("click", function() { contextMenu.style.display = "none"; });',
  '',
  '    async function execMenu(action) {',
  '        contextMenu.style.display = "none";',
  '        if(!ctxTargetKey && action !== "paste") return;',
  '        if (action === "open") {',
  '            if (ctxIsFolder) loadList(ctxTargetKey); else openFile(ctxTargetKey, ctxTargetKey.split("/").pop());',
  '        } else if (action === "share") {',
  '            if(ctxIsFolder) showToast("æ— æ³•ç›´æ¥åˆ†äº«æ–‡ä»¶å¤¹", "error"); else viewFile(ctxTargetKey);',
  '        } else if (action === "rename") {',
  '            var btn = ctxTargetEl.querySelector(".rename-btn"); if(btn) triggerRename(btn, ctxTargetKey, ctxIsFolder);',
  '        } else if (action === "cut") {',
  '            clipboardAction = "cut"; clipboardSource = ctxTargetKey; clipboardIsFolder = ctxIsFolder; statusMsg.innerText = "Cut: " + ctxTargetKey.split("/").pop();',
  '        } else if (action === "copy") {',
  '            clipboardAction = "copy"; clipboardSource = ctxTargetKey; clipboardIsFolder = ctxIsFolder; statusMsg.innerText = "Copied: " + ctxTargetKey.split("/").pop();',
  '        } else if (action === "paste") { handlePaste();',
  '        } else if (action === "move") { triggerMove(ctxTargetKey, ctxIsFolder);',
  '        } else if (action === "copy_link") { copyLink(null, ctxTargetKey);',
  '        } else if (action === "download") { if(ctxIsFolder) showToast("æš‚ä¸æ”¯æŒæ–‡ä»¶å¤¹ä¸‹è½½", "error"); else downloadFile(null, ctxTargetKey);',
  '        } else if (action === "info") { if(ctxIsFolder) showFolderInfo(ctxTargetKey); else showFileInfo(ctxTargetKey);',
  '        } else if (action === "delete") { if(ctxIsFolder) deleteFolder(ctxTargetKey); else deleteFile(ctxTargetKey); }',
  '    }',
  '',
  '    async function handlePaste() {',
  '        if (!clipboardAction || !clipboardSource) return;',
  '        var destFolder = currentPrefix;',
  '        if (ctxIsFolder && ctxTargetKey) destFolder = ctxTargetKey;',
  '        var fileName = clipboardIsFolder ? clipboardSource.split("/").slice(-2)[0] + "/" : clipboardSource.split("/").pop();',
  '        var newKey = destFolder + fileName;',
  '        if (newKey === clipboardSource) {',
  '            if (clipboardIsFolder) { var folderName = fileName.slice(0, -1); newKey = destFolder + folderName + " - Copy/"; }',
  '            else { var parts = fileName.split("."); if (parts.length > 1) { var ext = parts.pop(); newKey = destFolder + parts.join(".") + " - Copy." + ext; } else { newKey = destFolder + fileName + " - Copy"; } }',
  '        }',
  '        statusMsg.innerText = "Pasting...";',
  '        try {',
  '            if (clipboardAction === "cut") {',
  '                var res = await apiFetch("/api/rename", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ oldKey: clipboardSource, newKey: newKey, isFolder: clipboardIsFolder }) });',
  '                if(res.ok) { statusMsg.innerText = "Moved"; clipboardAction = null; reloadList(); } else { res.text().then(t => showToast("Error: " + t, "error")); }',
  '            } else if (clipboardAction === "copy") {',
  '                var res = await apiFetch("/api/copy", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ srcKey: clipboardSource, destKey: newKey, isFolder: clipboardIsFolder }) });',
  '                if(res.ok) { statusMsg.innerText = "Copied"; reloadList(); } else { res.text().then(t => showToast("Error: " + t, "error")); }',
  '            }',
  '        } catch(e) { console.error(e); showToast("Paste failed", "error"); }',
  '    }',
  '',
  '    /* --- å¢å¼ºç‰ˆ: è‡ªåŠ¨ä¿å­˜é€»è¾‘ (åˆ‡æ¢æ–‡ä»¶/ç›®å½•æ—¶è§¦å‘) --- */',
  '    async function autoSavePrevious() {',
  '        if (currentEditingKey && isUnsaved && !editor.disabled) {',
  '            statusMsg.innerText = "Auto-saving...";',
  '            showToast("æ­£åœ¨è‡ªåŠ¨ä¿å­˜...", "info");',
  '            try {',
  '                await apiFetch("/api/put/" + encodeURIComponent(currentEditingKey), { ',
  '                    method: "POST", ',
  '                    headers: {"Content-Type": "text/plain; charset=utf-8"},',
  '                    body: editor.value ',
  '                });',
  '                statusMsg.innerText = "Saved (Auto)";',
  '                isUnsaved = false;',
  '            } catch(e) { ',
  '                statusMsg.innerText = "Auto-save failed"; ',
  '                showToast("è‡ªåŠ¨ä¿å­˜å¤±è´¥: " + e.message, "error");',
  '                console.error(e); ',
  '            }',
  '        }',
  '        isUnsaved = false;',
  '    }',
  '',
  '    async function reloadList() { await autoSavePrevious(); loadList(currentPrefix); }',
  '    function formatSize(bytes) { if (bytes === 0) return "0 B"; var k = 1024; var i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + ["B","KB","MB","GB","TB"][i]; }',
  '    function formatTime(seconds) { if (!isFinite(seconds) || seconds < 0) return "--"; if (seconds < 60) return Math.ceil(seconds) + "s"; var m = Math.floor(seconds / 60); var s = Math.ceil(seconds % 60); return m + "m " + s + "s"; }',
  '    function handleDragStart(e, key, isFolder) { e.dataTransfer.setData("text/plain", JSON.stringify({ key: key, isFolder: isFolder })); e.dataTransfer.effectAllowed = "move"; }',
  '    function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add("drag-target-hover"); }',
  '    function handleDragLeave(e) { e.currentTarget.classList.remove("drag-target-hover"); }',
  '    async function handleDrop(e, targetFolderPrefix) {',
  '        e.preventDefault(); e.currentTarget.classList.remove("drag-target-hover");',
  '        try {',
  '          var data = JSON.parse(e.dataTransfer.getData("text/plain")); var srcKey = data.key; var srcIsFolder = data.isFolder;',
  '          if(!srcKey || (srcIsFolder && targetFolderPrefix.startsWith(srcKey)) || srcKey === targetFolderPrefix) return;',
  '          var fileName = srcIsFolder ? srcKey.split("/").slice(-2)[0] + "/" : srcKey.split("/").pop(); var newKey = targetFolderPrefix + fileName;',
  '          if(srcKey === newKey) return;',
  '          statusMsg.innerText = "Moving...";',
  '          var res = await apiFetch("/api/rename", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ oldKey: srcKey, newKey: newKey, isFolder: srcIsFolder }) });',
  '          if(res.ok) { statusMsg.innerText = "Moved!"; reloadList(); } else { res.text().then(t => showToast("Error: " + t, "error")); }',
  '        } catch(err) { console.error(err); }',
  '    }',
  '',
  '    function viewFile(key) { var url = "/api/share/" + encodeURIComponent(key); window.open(url, "_blank"); }',
  '',
  '    /* --- Helper: Get File Icon --- */',
  '    function getFileIcon(name) {',
  '        if (/\\.(jpg|jpeg|png|gif|webp|svg|ico|bmp)$/i.test(name)) return "ğŸ–¼ï¸";',
  '        if (/\\.(mp4|webm|ogv|mov|mkv|m3u8|ts)$/i.test(name)) return "ğŸ¬";',
  '        if (/\\.(mp3|wav|ogg|m4a|aac|flac)$/i.test(name)) return "ğŸµ";',
  '        if (/\\.(zip|rar|7z|tar|gz)$/i.test(name)) return "ğŸ“¦";',
  '        return "ğŸ“„";',
  '    }',
  '',
  '    function loadList(prefix) {',
  '      pathDisplay.innerHTML = "Loading...";',
  '      apiFetch("/api/list?prefix=" + encodeURIComponent(prefix)).then(r => r.json()).then(data => {',
  '        currentPrefix = prefix; pathDisplay.innerHTML = "root/ " + (prefix ? prefix : ""); pathDisplay.scrollLeft = pathDisplay.scrollWidth;',
  '        var listDiv = document.getElementById("file-list"); listDiv.innerHTML = ""; availableFolders = data.folders ? data.folders : [];',
  '        if (currentPrefix !== "") {',
  '          var p = currentPrefix.split("/"); p.pop(); p.pop(); var parentPrefix = p.length > 0 ? p.join("/") + "/" : "";',
  '          var div = document.createElement("div"); div.className = "file-item"; div.innerHTML = "<span class=\'file-name\' style=\'color:#aaa\'>ğŸ”™ .. (è¿”å›ä¸Šçº§)</span>";',
  '          div.onclick = goUp; div.ondragover = handleDragOver; div.ondragleave = handleDragLeave; div.ondrop = function(e) { handleDrop(e, parentPrefix); }; div.oncontextmenu = function(e) { showContextMenu(e, parentPrefix, true, this); }; listDiv.appendChild(div);',
  '        }',
  '        if (data.folders) {',
  '          data.folders.sort();',
  '          data.folders.forEach(folderPrefix => {',
  '            var displayName = folderPrefix.slice(currentPrefix.length); var showName = displayName.endsWith("/") ? displayName.slice(0, -1) : displayName;',
  '            var div = document.createElement("div"); div.className = "file-item"; div.draggable = true;',
  '            div.ondragstart = function(e) { handleDragStart(e, folderPrefix, true); }; div.ondragover = handleDragOver; div.ondragleave = handleDragLeave; div.ondrop = function(e) { handleDrop(e, folderPrefix); }; div.oncontextmenu = function(e) { showContextMenu(e, folderPrefix, true, this); };',
  '            var html = "<div class=\'file-name-container\'><span class=\'folder-icon\'>ğŸ“</span> <span class=\'file-name\'>" + showName + "</span></div><div class=\'actions\'><button class=\'icon-btn rename-btn\' onclick=\'triggerRename(this, \\"" + folderPrefix + "\\", true)\'>âœ</button><button class=\'icon-btn move-btn\' onclick=\'triggerMove(\\"" + folderPrefix + "\\", true)\'>âœ</button><button class=\'icon-btn del-btn\' onclick=\'deleteFolder(\\"" + folderPrefix + "\\")\'>Ã—</button></div>";',
  '            div.innerHTML = html;',
  '            div.onclick = async function(e) { if(e.target.tagName === "BUTTON" || e.target.tagName === "INPUT" || isRenaming) return; await autoSavePrevious(); loadList(folderPrefix); };',
  '            listDiv.appendChild(div);',
  '          });',
  '        }',
  '        if (data.files) {',
  '          data.files.sort(function(a, b) { return new Date(b.uploaded) - new Date(a.uploaded); });',
  '          data.files.forEach(f => {',
  '            var displayName = f.key.slice(currentPrefix.length); if(!displayName) return;',
  '            var div = document.createElement("div"); div.className = "file-item"; div.draggable = true;',
  '            div.ondragstart = function(e) { handleDragStart(e, f.key, false); }; div.oncontextmenu = function(e) { showContextMenu(e, f.key, false, this); };',
  '            var keySafe = encodeURIComponent(f.key);',
  '            var icon = getFileIcon(displayName);',
  '            // æŒ‰é’®éƒ¨åˆ†ä½¿ç”¨äº† this ä¼ å‚',
  '            var html = "<div class=\'file-name-container\'><span class=\'file-icon\'>" + icon + "</span> <span class=\'file-name\' title=\'" + f.key + "\'>" + displayName + "</span></div><div class=\'actions\'><button class=\'icon-btn\' onclick=\'viewFile(\\"" + f.key + "\\")\'>ğŸŒ</button><button class=\'icon-btn info-btn\' onclick=\'showFileInfo(\\"" + f.key + "\\")\'>â„¹</button><button class=\'icon-btn rename-btn\' onclick=\'triggerRename(this, \\"" + f.key + "\\", false)\'>âœ</button><button class=\'icon-btn move-btn\' onclick=\'triggerMove(\\"" + f.key + "\\", false)\'>âœ</button><button class=\'icon-btn copy-btn\' onclick=\'copyLink(this, \\"" + keySafe + "\\")\'>ğŸ”—</button><button class=\'icon-btn\' onclick=\'downloadFile(this, \\"" + keySafe + "\\")\'>â¬‡</button><button class=\'icon-btn del-btn\' onclick=\'deleteFile(\\"" + f.key + "\\")\'>Ã—</button></div>";',
  '            div.innerHTML = html;',
  '            div.onclick = async function(e) { if(e.target.tagName === "BUTTON" || e.target.tagName === "INPUT" || isRenaming) return; await openFile(f.key, displayName); };',
  '            listDiv.appendChild(div);',
  '          });',
  '        }',
  '      }).catch(e => { console.log(e); });',
  '    }',
  '',
  '    function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }',
  '    document.querySelectorAll(".modal-overlay").forEach(overlay => { if(overlay.id === "login-modal") return; overlay.addEventListener("click", function(e) { if (e.target === overlay) overlay.style.display = "none"; }); });',
  '',
  '    /* --- æ ¸å¿ƒ: é‡å‘½åè¾“å…¥æ¡†è‡ªåŠ¨æäº¤ (ä¿®å¤Blurå¤±æ•ˆ) --- */',
  '    function triggerRename(btn, oldKey, isFolder) {',
  '        event.stopPropagation(); isRenaming = true;',
  '        var row = btn.closest(".file-item"); row.draggable = false;',
  '        var container = row.querySelector(".file-name-container"); var nameSpan = container.querySelector(".file-name");',
  '        var currentName = nameSpan.innerText; var originalHtml = container.innerHTML;',
  '        container.innerHTML = "<input type=\'text\' class=\'rename-input\' value=\'" + currentName + "\'>";',
  '        var input = container.querySelector("input"); input.focus(); input.oncontextmenu = function(e) { e.stopPropagation(); };',
  '        var isSubmitting = false;',
  '        async function submit() {',
  '            if (isSubmitting) return;',
  '            var newName = input.value.trim();',
  '            if (!newName || newName === currentName) { container.innerHTML = originalHtml; isRenaming = false; row.draggable = true; return; }',
  '            isSubmitting = true;',
  '            input.disabled = true; // é”å®š',
  '            var newFullKey = isFolder ? oldKey.substring(0, oldKey.length - currentName.length - 1) + newName + "/" : oldKey.substring(0, oldKey.length - currentName.length) + newName;',
  '            statusMsg.innerText = "Renaming...";',
  '            try {',
  '                var res = await apiFetch("/api/rename", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ oldKey: oldKey, newKey: newFullKey, isFolder: isFolder }) });',
  '                isRenaming = false; row.draggable = true;',
  '                if(res.ok) { statusMsg.innerText = "Renamed"; reloadList(); } else { res.text().then(t => { showToast("Error: " + t, "error"); container.innerHTML = originalHtml; }); }',
  '            } catch(e) {',
  '                showToast("Connection failed", "error"); container.innerHTML = originalHtml; isRenaming = false;',
  '            }',
  '        }',
  '        input.onclick = function(e) { e.stopPropagation(); }; ',
  '        input.onkeydown = function(e) { if(e.key === "Enter") { e.preventDefault(); input.blur(); } if(e.key === "Escape") { container.innerHTML = originalHtml; isRenaming = false; row.draggable = true; } }; ',
  '        input.onblur = submit;',
  '    }',
  '',
  '    function triggerMove(key, isFolder) {',
  '        event.stopPropagation(); targetMoveKey = key; targetMoveIsFolder = isFolder;',
  '        var parts = key.split("/"); targetMoveName = isFolder ? parts[parts.length - 2] + "/" : parts[parts.length - 1];',
  '        var modal = document.getElementById("move-modal"); var select = document.getElementById("move-folder-select"); var input = document.getElementById("move-input");',
  '        select.innerHTML = ""; var optCurr = document.createElement("option"); optCurr.value = currentPrefix; optCurr.text = "å½“å‰ç›®å½• (" + (currentPrefix || "Root") + ")"; select.appendChild(optCurr);',
  '        if (currentPrefix !== "") { var optRoot = document.createElement("option"); optRoot.value = ""; optRoot.text = "Root /"; select.appendChild(optRoot); var partsPrefix = currentPrefix.split("/"); partsPrefix.pop(); partsPrefix.pop(); var parentPrefix = partsPrefix.length > 0 ? partsPrefix.join("/") + "/" : ""; var optParent = document.createElement("option"); optParent.value = parentPrefix; optParent.text = "ä¸Šçº§ç›®å½• (../)"; select.appendChild(optParent); }',
  '        availableFolders.forEach(fp => { if (fp === key) return; var opt = document.createElement("option"); opt.value = fp; opt.text = "ğŸ“‚ " + fp.slice(currentPrefix.length); select.appendChild(opt); });',
  '        input.value = key; modal.style.display = "flex"; input.focus();',
  '    }',
  '    function updateMoveInput() { var select = document.getElementById("move-folder-select"); var input = document.getElementById("move-input"); input.value = select.value + targetMoveName; }',
  '    function submitMove() {',
  '        var newKey = document.getElementById("move-input").value.trim(); if(!newKey || newKey === targetMoveKey) { closeModal("move-modal"); return; }',
  '        if(targetMoveIsFolder && !newKey.endsWith("/")) newKey += "/";',
  '        statusMsg.innerText = "Moving...";',
  '        apiFetch("/api/rename", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({ oldKey: targetMoveKey, newKey: newKey, isFolder: targetMoveIsFolder }) }).then(res => { closeModal("move-modal"); if(res.ok) { statusMsg.innerText = "Moved!"; reloadList(); } else { res.text().then(t => showToast("Error: " + t, "error")); } });',
  '    }',
  '',
  '    /* --- ä¼˜åŒ–: å¤åˆ¶é“¾æ¥ (å¸¦æŒ‰é’®åé¦ˆ) --- */',
  '    async function copyLink(btnEl, key) { ',
  '        event.stopPropagation(); ',
  '        var url = window.location.origin + "/api/download/" + key;',
  '        try {',
  '            await navigator.clipboard.writeText(url);',
  '            showToast("é“¾æ¥å·²å¤åˆ¶! ğŸ”—", "success");',
  '            if(btnEl) {',
  '                var originalIcon = btnEl.innerHTML;',
  '                btnEl.innerHTML = "âœ…";',
  '                btnEl.classList.add("btn-success");',
  '                setTimeout(() => {',
  '                    btnEl.innerHTML = originalIcon;',
  '                    btnEl.classList.remove("btn-success");',
  '                }, 1500);',
  '            }',
  '        } catch(e) {',
  '            showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", "error");',
  '        }',
  '    }',
  '',
  '    /* --- ä¼˜åŒ–: ä¸‹è½½æ–‡ä»¶ (å¸¦åŠ è½½çŠ¶æ€åé¦ˆ) --- */',
  '    async function downloadFile(btnEl, key) { ',
  '        event.stopPropagation(); ',
  '        if(btnEl && btnEl.classList) btnEl.classList.add("btn-loading");',
  '        showToast("æ­£åœ¨è¯·æ±‚æ–‡ä»¶ä¸‹è½½...", "info");',
  '',
  '        try {',
  '            var res = await apiFetch("/api/download/" + key); ',
  '            if(!res.ok) throw new Error("Network response was not ok");',
  '            ',
  '            var blob = await res.blob(); ',
  '            var url = window.URL.createObjectURL(blob); ',
  '            var a = document.createElement("a"); ',
  '            a.href = url; ',
  '            a.download = decodeURIComponent(key).split("/").pop(); ',
  '            document.body.appendChild(a);',
  '            a.click();',
  '            document.body.removeChild(a);',
  '            window.URL.revokeObjectURL(url);',
  '            ',
  '            showToast("å¼€å§‹ä¸‹è½½ â¬‡ï¸", "success");',
  '        } catch(e) {',
  '            console.error(e);',
  '            showToast("ä¸‹è½½è¯·æ±‚å¤±è´¥", "error");',
  '        } finally {',
  '            if(btnEl && btnEl.classList) btnEl.classList.remove("btn-loading");',
  '        }',
  '    }',
  '',
  '    /* --- ä¼˜åŒ–: åˆ é™¤é€»è¾‘ (å¯¹æ¥æ–°çš„å¼¹çª—) --- */',
  '    function deleteFile(key) { ',
  '        event.stopPropagation(); ',
  '        showConfirmDialog(',
  '            "æ°¸ä¹…åˆ é™¤æ–‡ä»¶?", ',
  '            "æ‚¨ç¡®å®šè¦åˆ é™¤ <span class=\'confirm-file-highlight\'>" + key.split(\'/\').pop() + "</span> å—ï¼Ÿ<br>æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚", ',
  '            () => {',
  '                showToast("æ­£åœ¨åˆ é™¤...", "info");',
  '                apiFetch("/api/delete/" + encodeURIComponent(key), { method: "DELETE" })',
  '                .then(() => { ',
  '                    showToast("æ–‡ä»¶å·²åˆ é™¤", "success");',
  '                    reloadList(); ',
  '                    showMobileSidebar(); ',
  '                })',
  '                .catch(e => showToast("åˆ é™¤å¤±è´¥: " + e, "error"));',
  '            }',
  '        ); ',
  '    }',
  '    function deleteFolder(key) { ',
  '        event.stopPropagation(); ',
  '        showConfirmDialog(',
  '            "åˆ é™¤æ–‡ä»¶å¤¹?", ',
  '            "æ‚¨ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ <span class=\'confirm-file-highlight\'>" + key + "</span> åŠå…¶åŒ…å«çš„æ‰€æœ‰å†…å®¹å—ï¼Ÿ<br>æ­¤æ“ä½œ<b>æ— æ³•æ¢å¤</b>ã€‚", ',
  '            () => {',
  '                showToast("æ­£åœ¨åˆ é™¤æ–‡ä»¶å¤¹...", "info");',
  '                apiFetch("/api/delete_folder/" + encodeURIComponent(key), { method: "DELETE" })',
  '                .then(() => { ',
  '                    showToast("æ–‡ä»¶å¤¹å·²åˆ é™¤", "success");',
  '                    reloadList(); ',
  '                })',
  '                .catch(e => showToast("åˆ é™¤å¤±è´¥: " + e, "error"));',
  '            }',
  '        ); ',
  '    }',
  '',
  '    /* --- ä¼˜åŒ–: ç¾åŒ–çš„ç¡®è®¤å¼¹çª— --- */',
  '    function showConfirmDialog(title, messageHtml, actionCallback) { ',
  '        var html = `',
  '            <div class="confirm-icon-box">',
  '                <span class="confirm-icon">ğŸ—‘ï¸</span>',
  '            </div>',
  '            <div style="text-align: center;">',
  '                <div class="confirm-title">${title}</div>',
  '                <div class="confirm-desc">${messageHtml}</div>',
  '            </div>',
  '        `;',
  '        document.getElementById("confirm-message").innerHTML = html; ',
  '        var btn = document.getElementById("confirm-btn-ok"); ',
  '        var newBtn = btn.cloneNode(true);',
  '        btn.parentNode.replaceChild(newBtn, btn);',
  '        newBtn.onclick = function() { ',
  '            actionCallback(); ',
  '            closeModal("confirm-modal"); ',
  '        }; ',
  '        document.getElementById("confirm-modal").style.display = "flex"; ',
  '    }',
  '',
  '    function renderRow(label, value) { return "<div class=\'info-card-item\'><span class=\'info-label\'>" + label + "</span><span class=\'info-value\'>" + value + "</span></div>"; }',
  '    function showFileInfo(key) { ',
  '        event.stopPropagation(); document.getElementById("info-modal").style.display = "flex"; document.getElementById("modal-content").innerHTML = "Loading..."; ',
  '        apiFetch("/api/info?key=" + encodeURIComponent(key)).then(r => r.json()).then(info => { ',
  '            var icon = getFileIcon(info.name);',
  '            var html = "<div style=\'text-align:center; margin-bottom:20px;\'><div style=\'font-size:48px; margin-bottom:10px;\'>" + icon + "</div><div style=\'font-size:16px; font-weight:bold; word-break:break-all; color:#fff;\'>" + info.name + "</div></div>";',
  '            html += "<div class=\'info-list\'>";',
  '            html += renderRow("ğŸ“ è·¯å¾„", info.key);',
  '            html += renderRow("ğŸ“¦ å¤§å°", formatSize(info.size));',
  '            html += renderRow("ğŸ·ï¸ ç±»å‹", info.contentType || "Unknown");',
  '            html += renderRow("ğŸ“… ä¿®æ”¹æ—¶é—´", new Date(info.uploaded).toLocaleString());',
  '            html += "</div>";',
  '            document.getElementById("modal-content").innerHTML = html; ',
  '        }); ',
  '    }',
  '    function showFolderInfo(prefix) { ',
  '        event.stopPropagation(); document.getElementById("info-modal").style.display = "flex"; ',
  '        var html = "<div style=\'text-align:center; margin-bottom:20px;\'><div style=\'font-size:48px; margin-bottom:10px;\'>ğŸ“‚</div><div style=\'font-size:16px; font-weight:bold; word-break:break-all; color:#fff;\'>" + prefix + "</div></div>";',
  '        html += "<div class=\'info-list\'>" + renderRow("ç±»å‹", "Folder / Directory") + "</div>";',
  '        document.getElementById("modal-content").innerHTML = html; ',
  '    }',
  '    /* --- æ ¸å¿ƒ: æ–°å»ºæ–‡ä»¶/æ–‡ä»¶å¤¹è¾“å…¥æ¡†è‡ªåŠ¨æäº¤ (ä¿®å¤Blurå¤±æ•ˆ) --- */',
  '    function createEntry(type) { ',
  '        var listDiv = document.getElementById("file-list"); ',
  '        var div = document.createElement("div"); ',
  '        div.className = "file-item new-entry-row"; ',
  '        div.innerHTML = "<div class=\'file-name-container\'>" + (type==="folder"?"ğŸ“":"ğŸ“„") + " <input type=\'text\' class=\'rename-input\'></div>"; ',
  '        listDiv.insertBefore(div, listDiv.firstChild); ',
  '        var input = div.querySelector("input"); ',
  '        input.focus(); ',
  '        var isSubmitting = false;',
  '        async function submit() {',
  '            if (isSubmitting) return;',
  '            var name = input.value.trim(); ',
  '            if(!name) { div.remove(); return; } ',
  '            isSubmitting = true;',
  '            input.disabled = true; // é”å®šè¾“å…¥æ¡†',
  '            var newKey = currentPrefix + name + (type==="folder"?"/":""); ',
  '            try {',
  '                await apiFetch("/api/put/" + encodeURIComponent(newKey), { method: "POST" });',
  '                div.remove(); ',
  '                await reloadList(); ',
  '                showToast("Created successfully", "success");',
  '            } catch(e) { ',
  '                showToast("åˆ›å»ºå¤±è´¥", "error"); ',
  '                input.disabled = false; input.focus(); isSubmitting = false;',
  '            } ',
  '        }',
  '        input.onblur = submit;',
  '        input.onkeydown = function(e) { if(e.key==="Enter") { e.preventDefault(); input.blur(); } if(e.key==="Escape") div.remove(); }; ',
  '    }',
  '    async function goUp() { await autoSavePrevious(); var p = currentPrefix.split("/"); p.pop(); p.pop(); loadList(p.length>0 ? p.join("/")+"/" : ""); }',
  '',
  '    /* --- æ ¸å¿ƒ: æ–‡æœ¬/äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½é€»è¾‘ (å·²ä¿®å¤ç¼“å­˜é—®é¢˜) --- */',
  '    async function loadTextFile(key) {',
  '        var editorEl = document.getElementById("editor");',
  '        hideAll(); editorEl.style.display = "block"; editorEl.disabled = false;',
  '        statusMsg.innerText = "Downloading...";',
  '        try {',
  '            // Fix: æ·»åŠ  ?v=æ—¶é—´æˆ³ é˜²æ­¢æµè§ˆå™¨è¯»å–ç¼“å­˜çš„æ—§æ–‡ä»¶',
  '            var text = await (await apiFetch("/api/get/" + encodeURIComponent(key) + "?v=" + Date.now())).text();',
  '            editorEl.value = text;',
  '            statusMsg.innerText = "Loaded";',
  '        } catch(e) {',
  '            console.error(e);',
  '            editorEl.value = "Error loading file: " + e.message;',
  '            statusMsg.innerText = "Error";',
  '        }',
  '    }',
  '',
  '    /* --- æ ¸å¿ƒ: æ‰“å¼€æ–‡ä»¶ (å¢å¼ºæ··åˆåŠ è½½ç‰ˆ + TS Support + å¤§æ–‡ä»¶/äºŒè¿›åˆ¶å¡ç‰‡è§†å›¾) --- */',
  '    async function openFile(key, shortName) {',
  '        await autoSavePrevious();',
  '        currentEditingKey = key;',
  '        isUnsaved = false;',
  '        statusMsg.innerText = "Checking...";',
  '        filenameInput.value = shortName;',
  '        showMobileEditor();',
  '',
  '        var ext = key.split(".").pop().toLowerCase();',
  '        var isImg = /^(jpg|jpeg|png|gif|webp|svg|ico|bmp)$/i.test(ext);',
  '        var isVideo = /^(mp4|webm|ogv|mov|mkv|m3u8|ts)$/i.test(ext);',
  '        var isAudio = /^(mp3|wav|ogg|m4a|aac|flac)$/i.test(ext);',
  '        var isHls = ext === "m3u8";',
  '        var isTs = ext === "ts";',
  '        ',
  '        var editorEl = document.getElementById("editor");',
  '        var imgContainer = document.getElementById("image-preview");',
  '        var videoContainer = document.getElementById("video-preview");',
  '        var audioContainer = document.getElementById("audio-preview");',
  '        var npContainer = document.getElementById("no-preview-view");',
  '        var imgEl = imgContainer.querySelector("img");',
  '        var videoEl = document.getElementById("main-video");',
  '        var customAudioPlayer = document.getElementById("custom-audio-player");',
  '        ',
  '        // é‡ç½®æ‰€æœ‰æ’­æ”¾å™¨å’ŒURL',
  '        if (currentMediaUrl) { URL.revokeObjectURL(currentMediaUrl); currentMediaUrl = null; }',
  '        videoEl.pause(); videoEl.removeAttribute("src"); videoEl.load();',
  '        if (hls) { hls.destroy(); hls = null; }',
  '        if (mpegtsPlayer) { mpegtsPlayer.destroy(); mpegtsPlayer = null; } // é”€æ¯ mpegts å®ä¾‹',
  '        audioEl.pause(); audioEl.src = "";',
  '        imgEl.src = "";',
  '',
  '        try {',
  '              var infoRes = await apiFetch("/api/info?key=" + encodeURIComponent(key));',
  '              if (!infoRes.ok) throw new Error("Info fetch failed");',
  '              var info = await infoRes.json();',
  '',
  '              statusMsg.innerText = "Loading...";',
  '              /* 50MB é˜ˆå€¼: å°äºåˆ™ä½¿ç”¨ Blob (å†…å­˜åŠ è½½/æ‹–åŠ¨æœ€å¿«)ï¼Œå¤§äºåˆ™ä½¿ç”¨ Rangeæµå¼æ’­æ”¾ */',
  '              var isSmallFile = info.size < 300 * 1024 * 1024;',
  '              var streamUrl = "/api/get/" + encodeURIComponent(key) + "?t=" + encodeURIComponent(authToken);',
  '',
  '              if (isImg) {',
  '                  hideAll(); imgContainer.style.display = "flex"; editorEl.disabled = true;',
  '                  var blob = await (await apiFetch("/api/get/" + encodeURIComponent(key))).blob();',
  '                  currentMediaUrl = URL.createObjectURL(blob);',
  '                  imgEl.src = currentMediaUrl;',
  '                  statusMsg.innerText = "Image Loaded";',
  '              } else if (isVideo) {',
  '                  hideAll(); videoContainer.style.display = "flex"; editorEl.disabled = true;',
  '                  ',
  '                  // --- TS è§†é¢‘å¤„ç†é€»è¾‘ (mpegts.js) ---',
  '                  if (isTs && mpegts.getFeatureList().mseLivePlayback) {',
  '                        mpegtsPlayer = mpegts.createPlayer({',
  '                           type: "mpegts",  // æ˜ç¡®æŒ‡å®šç±»å‹',
  '                           url: streamUrl,',
  '                           isLive: false',
  '                        });',
  '                        mpegtsPlayer.attachMediaElement(videoEl);',
  '                        mpegtsPlayer.load();',
  '                        mpegtsPlayer.play();',
  '                        statusMsg.innerText = "MPEG-TS Stream Ready";',
  '                  } ',
  '                  // --- HLS è§†é¢‘å¤„ç†é€»è¾‘ ---',
  '                  else if (isHls) {',
  '                      if (Hls.isSupported()) {',
  '                          hls = new Hls({',
  '                              xhrSetup: function(xhr, url) {',
  '                                  xhr.setRequestHeader("Authorization", "Basic " + authToken);',
  '                              }',
  '                          });',
  '                          hls.loadSource("/api/get/" + encodeURIComponent(key));',
  '                          hls.attachMedia(videoEl);',
  '                          hls.on(Hls.Events.MANIFEST_PARSED, function() { videoEl.play(); });',
  '                          statusMsg.innerText = "HLS Stream Ready";',
  '                      } else if (videoEl.canPlayType("application/vnd.apple.mpegurl")) {',
  '                          videoEl.src = streamUrl;',
  '                          statusMsg.innerText = "Native HLS Ready";',
  '                      }',
  '                  } ',
  '                  // --- å¸¸è§„è§†é¢‘ (MP4/MKV/WebM) ---',
  '                  else {',
  '                      if (isSmallFile) {',
  '                          // å°æ–‡ä»¶: ä¸‹è½½ Blob æ’­æ”¾ (Auth å®Œç¾æ”¯æŒ, å†…å­˜åŠ è½½)',
  '                          var blob = await (await apiFetch("/api/get/" + encodeURIComponent(key))).blob();',
  '                          currentMediaUrl = URL.createObjectURL(blob);',
  '                          videoEl.src = currentMediaUrl;',
  '                          statusMsg.innerText = "Video Ready (Blob)";',
  '                      } else {',
  '                          // å¤§æ–‡ä»¶: æµå¼æ’­æ”¾ + URL Token è®¤è¯ (ä¾èµ–åç«¯ Range æ”¯æŒ)',
  '                          videoEl.src = streamUrl;',
  '                          statusMsg.innerText = "Stream Ready (Cloud)";',
  '                      }',
  '                  }',
  '              } else if (isAudio) {',
  '                  hideAll(); audioContainer.style.display = "flex"; customAudioPlayer.style.display = "flex"; editorEl.disabled = true;',
  '                  document.getElementById("player-title").innerText = shortName;',
  '                  if (isSmallFile) {',
  '                      var blob = await (await apiFetch("/api/get/" + encodeURIComponent(key))).blob();',
  '                      currentMediaUrl = URL.createObjectURL(blob);',
  '                      audioEl.src = currentMediaUrl;',
  '                      statusMsg.innerText = "Audio Ready (Blob)";',
  '                  } else {',
  '                      audioEl.src = streamUrl;',
  '                      statusMsg.innerText = "Audio Stream Ready";',
  '                  }',
  '              } else {',
  '                  /* ğŸ›¡ï¸ æ–°å¢: æ™ºèƒ½åˆ¤æ–­ (å¤§æ–‡ä»¶ æˆ– äºŒè¿›åˆ¶æ–‡ä»¶) -> ç»Ÿä¸€æ˜¾ç¤ºå¡ç‰‡è§†å›¾ */',
  '                  ',
  '                  /* å®šä¹‰å¸¸è§ä¸æ”¯æŒç›´æ¥é¢„è§ˆçš„äºŒè¿›åˆ¶/å‹ç¼©åŒ…/æ–‡æ¡£æ ¼å¼ */',
  '                  var isBinary = /^(zip|rar|7z|tar|gz|iso|dmg|pkg|exe|dll|bin|pdf|doc|docx|xls|xlsx|ppt|pptx|apk|psd|ai)$/i.test(ext);',
  '                  ',
  '                  if (info.size > 20 * 1024 * 1024 || isBinary) {',
  '                        hideAll();',
  '                        npContainer.style.display = "flex";',
  '                        ',
  '                        document.getElementById("np-filename").innerText = shortName;',
  '                        document.getElementById("np-meta").innerText = formatSize(info.size) + " | " + (info.contentType || "Unknown");',
  '                        document.getElementById("np-icon").innerText = getFileIcon(shortName);',
  '                        ',
  '                        /* åŠ¨æ€ä¿®æ”¹æç¤ºè¯­: æ˜¯å¤ªå¤§ï¼Œè¿˜æ˜¯æ ¼å¼ä¸æ”¯æŒ? */',
  '                        var reason = info.size > 20 * 1024 * 1024 ? "æ–‡ä»¶è¿‡å¤§" : "ä¸æ”¯æŒåœ¨çº¿é¢„è§ˆçš„æ ¼å¼";',
  '                        document.getElementById("np-warning").innerText = "âš ï¸ " + reason + " (å»ºè®®ä¸‹è½½)";',
  '                        ',
  '                        // ç»‘å®šä¸‹è½½äº‹ä»¶',
  '                        document.getElementById("np-download-btn").onclick = function() {',
  '                            downloadFile(null, encodeURIComponent(key));',
  '                        };',
  '                        ',
  '                        // ç»‘å®šå¼ºè¡Œç¼–è¾‘äº‹ä»¶',
  '                        document.getElementById("np-force-edit-btn").onclick = function() {',
  '                            loadTextFile(key);',
  '                        };',
  '                        ',
  '                        statusMsg.innerText = "No Preview View";',
  '                        return;',
  '                  }',
  '                  // æ­£å¸¸æ–‡æœ¬æ–‡ä»¶ç›´æ¥åŠ è½½',
  '                  await loadTextFile(key);',
  '              }',
  '        } catch(e) {',
  '              console.error(e);',
  '              hideAll(); editorEl.style.display = "block";',
  '              editorEl.value = "Error loading file: " + e.message;',
  '              statusMsg.innerText = "Error";',
  '        }',
  '    }',
  '    function hideAll() {',
  '        document.getElementById("editor").style.display="none";',
  '        document.getElementById("image-preview").style.display="none";',
  '        document.getElementById("video-preview").style.display="none";',
  '        document.getElementById("audio-preview").style.display="none";',
  '        document.getElementById("no-preview-view").style.display="none";',
  '    }',
  '',
  '    async function prepareNewFile() { await autoSavePrevious(); editor.value = ""; editor.disabled = false; filenameInput.value = ""; filenameInput.focus(); statusMsg.innerText = "New File Mode"; document.querySelectorAll(".file-item.active").forEach(el => el.classList.remove("active")); currentEditingKey = null; isUnsaved = false; showMobileEditor(); hideAll(); document.getElementById("editor").style.display="block"; }',
  '    async function handleSidebarNewFile() { await prepareNewFile(); createEntry("file"); }',
  '',
  '    /* --- å¢å¼ºç‰ˆ: æ‰‹åŠ¨ä¿å­˜é€»è¾‘ (ç‚¹å‡»æŒ‰é’®è§¦å‘) --- */',
  '    async function saveEditorContent() {',
  '        if(editor.disabled) { showToast("æ­¤æ–‡ä»¶æ— æ³•ç¼–è¾‘ä¿å­˜", "error"); return; }',
  '        ',
  '        var newName = filenameInput.value.trim(); ',
  '        if (!newName) return showToast("æ–‡ä»¶åä¸èƒ½ä¸ºç©º", "error");',
  '',
  '        var newKey = currentPrefix + newName;',
  '        ',
  '        statusMsg.innerText = "Saving...";',
  '        ',
  '        // 1. å¤„ç†é‡å‘½åé€»è¾‘',
  '        if (currentEditingKey && newKey !== currentEditingKey) {',
  '            if (isRenamingProcessing) { ',
  '                statusMsg.innerText = "Waiting for rename..."; ',
  '                while(isRenamingProcessing) await new Promise(r => setTimeout(r, 100)); ',
  '            }',
  '            // å¦‚æœç¡®å®æ”¹åäº†',
  '            if (newKey !== currentEditingKey) {',
  '                try { ',
  '                    var res = await apiFetch("/api/rename", { ',
  '                        method: "POST", ',
  '                        headers: {"Content-Type": "application/json"}, ',
  '                        body: JSON.stringify({ oldKey: currentEditingKey, newKey: newKey, isFolder: false }) ',
  '                    }); ',
  '                    if (res.ok) { ',
  '                        currentEditingKey = newKey; ',
  '                    } else { ',
  '                        var t = await res.text(); ',
  '                        if (!confirm("é‡å‘½åå¤±è´¥ (" + t + ")ã€‚æ˜¯å¦ä¿å­˜ä¸ºæ–°æ–‡ä»¶?")) return; ',
  '                    } ',
  '                } catch(e) { ',
  '                    showToast("é‡å‘½åé”™è¯¯: " + e, "error"); return; ',
  '                }',
  '            }',
  '        }',
  '',
  '        // 2. æ‰§è¡Œä¿å­˜',
  '        try {',
  '            await apiFetch("/api/put/" + encodeURIComponent(newKey), { ',
  '                method: "POST", ',
  '                headers: {"Content-Type": "text/plain; charset=utf-8"},',
  '                body: editor.value ',
  '            });',
  '            ',
  '            statusMsg.innerText = "Saved";',
  '            showToast("æ–‡ä»¶å·²ä¿å­˜", "success");',
  '            currentEditingKey = newKey;',
  '            isUnsaved = false;',
  '            reloadList(); ',
  '        } catch(e) {',
  '            showToast("ä¿å­˜å¤±è´¥: " + e.message, "error");',
  '            statusMsg.innerText = "Save Error";',
  '        }',
  '    }',
  '',
  '    function copyLink(btnEl, key) { event.stopPropagation(); navigator.clipboard.writeText(window.location.origin + "/api/download/" + key); statusMsg.innerText = "Copied"; }',
  '    function triggerFileUpload() { fileInput.click(); }',
  '    fileInput.addEventListener("change", function(e) { if(this.files.length) uploadFiles(this.files); this.value=""; });',
  '    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }',
  '    ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => sidebar.addEventListener(eventName, preventDefaults, false));',
  '    sidebar.addEventListener("drop", function(e) { sidebar.classList.remove("drag-active"); if(e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files); }, false);',
  '',
  '    /* --- æ ¸å¿ƒ: åˆ›å»ºè¿›åº¦æ¡ UI (å‡çº§ç‰ˆ) --- */',
  '    function createProgressUI(filename) {',
  '        var container = document.getElementById("upload-progress-container");',
  '        var div = document.createElement("div"); div.className = "progress-card";',
  '        div.innerHTML = "<div class=\'progress-header\'><span class=\'progress-filename\'>" + filename + "</span><span class=\'progress-percent\'>0%</span></div><div class=\'progress-bar-bg\'><div class=\'progress-bar-fill\'></div></div><div class=\'progress-details\'><span>Speed: -</span><span>ETA: -</span></div>";',
  '        container.appendChild(div);',
  '        return {',
  '            update: function(percent, speedStr, etaStr) {',
  '                div.querySelector(".progress-percent").innerText = percent + "%";',
  '                div.querySelector(".progress-bar-fill").style.width = percent + "%";',
  '                var details = div.querySelectorAll(".progress-details span");',
  '                if(speedStr) details[0].innerText = speedStr;',
  '                if(etaStr) details[1].innerText = "ETA: " + etaStr;',
  '            },',
  '            done: function() {',
  '                this.update(100, "Done", "0s"); setTimeout(() => { div.style.opacity="0"; setTimeout(() => div.remove(), 300); }, 1500);',
  '            },',
  '            error: function() {',
  '                div.querySelector(".progress-percent").innerText = "Error";',
  '                div.querySelector(".progress-bar-fill").style.background = "red";',
  '            }',
  '        };',
  '    }',
  '',
  '    /* --- æ ¸å¿ƒ: å¤šæ–‡ä»¶å¹¶å‘ä¸Šä¼ é€»è¾‘ (ä¿®æ­£é˜»å¡é—®é¢˜) --- */',
  '    async function uploadFiles(files) {',
  '        /* å°† FileList è½¬æ¢ä¸ºæ•°ç»„ï¼Œä»¥ä¾¿ä½¿ç”¨ map è¿›è¡Œå¹¶å‘æ“ä½œ */',
  '        var filesArray = Array.from(files);',
  '        ',
  '        statusMsg.innerText = "Processing " + filesArray.length + " files...";',
  '',
  '        /* æ˜ å°„æ¯ä¸ªæ–‡ä»¶ä¸ºä¸Šä¼  Promise */',
  '        var uploadPromises = filesArray.map(async function(file) {',
  '            var key = currentPrefix + file.name;',
  '            var ui = createProgressUI(file.name);',
  '            var startTime = Date.now();',
  '            ',
  '            try {',
  '                /* å°äº 50MB ç›´æ¥ä¸Šä¼  */',
  '                if (file.size < 50 * 1024 * 1024) {',
  '                      await new Promise((resolve, reject) => {',
  '                            var xhr = new XMLHttpRequest();',
  '                            xhr.open("POST", "/api/put/" + encodeURIComponent(key), true);',
  '                            xhr.setRequestHeader("Authorization", "Basic " + authToken);',
  '                            xhr.upload.onprogress = function(e) {',
  '                                if (e.lengthComputable) { ',
  '                                      var percent = Math.round((e.loaded / e.total) * 100); ',
  '                                      var elapsed = (Date.now() - startTime) / 1000;',
  '                                      var speed = elapsed > 0 ? e.loaded / elapsed : 0; // Bytes/s',
  '                                      var remainingBytes = e.total - e.loaded;',
  '                                      var eta = speed > 0 ? remainingBytes / speed : 0;',
  '                                      ui.update(percent, formatSize(speed) + "/s", formatTime(eta));',
  '                                }',
  '                            };',
  '                            xhr.onload = function() { if(xhr.status === 200) { ui.done(); resolve(); } else { ui.error(); reject(xhr.responseText); } };',
  '                            xhr.onerror = function() { ui.error(); reject("Network error"); };',
  '                            xhr.send(file);',
  '                      });',
  '                } else {',
  '                      /* å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼  */',
  '                      /* 1. åˆå§‹åŒ– */',
  '                      var initRes = await apiFetch("/api/mp/create?key=" + encodeURIComponent(key), { method: "POST" });',
  '                      if(!initRes.ok) throw new Error("Init failed");',
  '                      var { uploadId } = await initRes.json();',
  '',
  '                      var chunkSize = 10 * 1024 * 1024; /* 10MB chunk */',
  '                      var chunks = Math.ceil(file.size / chunkSize);',
  '                      var parts = [];',
  '                      var uploadedBytes = 0;',
  '',
  '                      for (var partNum = 0; partNum < chunks; partNum++) {',
  '                            var start = partNum * chunkSize;',
  '                            var end = Math.min(start + chunkSize, file.size);',
  '                            var chunk = file.slice(start, end);',
  '                            ',
  '                            /* ä¸Šä¼ åˆ†ç‰‡ */',
  '                            var partRes = await apiFetch("/api/mp/upload?key=" + encodeURIComponent(key) + "&id=" + uploadId + "&part=" + (partNum + 1), {',
  '                                method: "POST", body: chunk',
  '                            });',
  '                            if(!partRes.ok) throw new Error("Part failed");',
  '                            var partData = await partRes.json();',
  '                            parts.push(partData);',
  '                            ',
  '                            uploadedBytes += chunk.size;',
  '                            var percent = Math.round(((partNum + 1) / chunks) * 100);',
  '                            ',
  '                            /* è®¡ç®—é€Ÿç‡ */',
  '                            var elapsed = (Date.now() - startTime) / 1000;',
  '                            var speed = elapsed > 0 ? uploadedBytes / elapsed : 0;',
  '                            var remainingBytes = file.size - uploadedBytes;',
  '                            var eta = speed > 0 ? remainingBytes / speed : 0;',
  '                            ',
  '                            ui.update(percent, formatSize(speed) + "/s", formatTime(eta));',
  '                      }',
  '',
  '                      /* 3. å®Œæˆåˆå¹¶ */',
  '                      await apiFetch("/api/mp/complete?key=" + encodeURIComponent(key) + "&id=" + uploadId, {',
  '                            method: "POST", body: JSON.stringify({ parts: parts })',
  '                      });',
  '                      ui.done();',
  '                }',
  '            } catch(e) {',
  '                console.error(e); ui.error(); ',
  '                // ä¸ alert é˜»å¡å…¶ä»–æ–‡ä»¶ï¼Œåªåœ¨ UI æ˜¾ç¤ºçº¢æ¡',
  '            }',
  '        });',
  '',
  '        /* ç­‰å¾…æ‰€æœ‰ä¸Šä¼ å®Œæˆï¼ˆæ— è®ºæˆåŠŸä¸å¦ï¼‰ */',
  '        await Promise.all(uploadPromises);',
  '        statusMsg.innerText = "All Done"; ',
  '        reloadList();',
  '    }',
  '  </script>',
  '</body>',
  '</html>'
  ].join('\n');
   
  export default {
    async fetch(request, env) {
      const url = new URL(request.url);
      
      /* --- Auth Check Logic with URL Token Support --- */
      const checkAuth = async (req) => {
        if (!env.AUTH_USER || !env.AUTH_SECRET) return true;
        
        // 1. Check Header (Basic Auth)
        const h = req.headers.get('Authorization');
        if (h) {
             try { const [u, p] = atob(h.split(' ')[1]).split(':'); if(u === env.AUTH_USER && p === env.AUTH_SECRET) return true; } catch(e) {}
        }
        
        // 2. Check URL Param "t" (Token Auth for Streaming)
        const t = new URL(req.url).searchParams.get('t');
        if (t) {
             try { const [u, p] = atob(t).split(':'); if(u === env.AUTH_USER && p === env.AUTH_SECRET) return true; } catch(e) {}
        }
        
        return false;
      };
   
      if (!url.pathname.startsWith('/api/')) return new Response(htmlParts, { headers: { 'Content-Type': 'text/html;charset=UTF-8' } });
        
      if (!url.pathname.startsWith('/api/share/') && !url.pathname.startsWith('/api/download/') && !await checkAuth(request)) {
          return new Response('Unauthorized', { status: 401 });
      }
   
      if (url.pathname === '/api/list') {
        const prefix = url.searchParams.get('prefix') || '';
        const list = await env.MY_BUCKET.list({ prefix: prefix, delimiter: '/' });
        return new Response(JSON.stringify({ files: list.objects, folders: list.delimitedPrefixes }), { headers: { 'Content-Type': 'application/json' } });
      }

      /* --- æ ¸å¿ƒä¿®å¤: è§†é¢‘æµå¼æ’­æ”¾ & Range è¯·æ±‚ --- */
      if (url.pathname.startsWith('/api/get/')) {
        const key = decodeURIComponent(url.pathname.slice(9));
        const rangeHeader = request.headers.get('range');

        // 1. å‡†å¤‡ R2 å‚æ•° (æ”¯æŒ Range å’Œ If-Match)
        const getOptions = {
          range: rangeHeader ? rangeHeader : undefined,
          onlyIf: request.headers.get('if-match') ? { etagMatches: request.headers.get('if-match') } : undefined
        };

        try {
          const obj = await env.MY_BUCKET.get(key, getOptions);
          if (!obj) return new Response('404 Not Found', { status: 404 });

          const headers = new Headers();
          
          // 2. åŸºç¡€ Header (CORS å¯¹è§†é¢‘æ’­æ”¾è‡³å…³é‡è¦)
          obj.writeHttpMetadata(headers);
          headers.set('Access-Control-Allow-Origin', '*');
          headers.set('Access-Control-Allow-Methods', 'GET, HEAD, OPTIONS');
          headers.set('Accept-Ranges', 'bytes'); // å‘Šè¯‰æµè§ˆå™¨æ”¯æŒæ‹–åŠ¨
          
          // Fix: ç¼©çŸ­ç¼“å­˜æ—¶é—´ä¸º 60sï¼Œé¿å…ç¼–è¾‘å™¨ä¿å­˜åç«‹åˆ»è¯»å–åˆ°æ—§æ–‡ä»¶
          headers.set('Cache-Control', 'private, max-age=60'); 
          
          if (obj.httpEtag) headers.set('Etag', obj.httpEtag);

          // 3. MIME ç±»å‹æ™ºèƒ½è¡¥å…¨ (é˜²æ­¢ R2 å…ƒæ•°æ®ç¼ºå¤±)
          if (!headers.get('content-type') || headers.get('content-type') === 'application/octet-stream') {
            const ext = key.split('.').pop().toLowerCase();
            const mimeMap = {
              'mp4': 'video/mp4', 'mkv': 'video/x-matroska', 'webm': 'video/webm',
              'mov': 'video/quicktime', 'm3u8': 'application/vnd.apple.mpegurl', 'ts': 'video/mp2t',
              'mp3': 'audio/mpeg', 'wav': 'audio/wav', 'ogg': 'audio/ogg', 'flac': 'audio/flac'
            };
            if (mimeMap[ext]) headers.set('Content-Type', mimeMap[ext]);
          }

          // 4. å¤„ç† Range å“åº” (206 Partial Content)
          if (rangeHeader && obj.range) {
            const start = obj.range.offset;
            const length = obj.range.length;
            const end = start + length - 1;
            const total = obj.size;

            headers.set('Content-Range', `bytes ${start}-${end}/${total}`);
            headers.set('Content-Length', length.toString());
            
            return new Response(obj.body, { status: 206, headers });
          }

          // 5. å®Œæ•´å“åº” (200 OK)
          headers.set('Content-Length', obj.size.toString());
          return new Response(obj.body, { status: 200, headers });

        } catch (e) {
          if (e.message.includes('RangeNotSatisfiable')) {
             return new Response('Requested Range Not Satisfiable', { status: 416 });
          }
          return new Response('Internal Error: ' + e.message, { status: 500 });
        }
      }

      if (url.pathname === '/api/info') {
        const obj = await env.MY_BUCKET.head(url.searchParams.get('key'));
        if(!obj) return new Response('404', { status: 404 });
        return new Response(JSON.stringify({ name: obj.key.split('/').pop(), key: obj.key, size: obj.size, uploaded: obj.uploaded, contentType: obj.httpMetadata?.contentType }), { headers: { 'Content-Type': 'application/json' } });
      }
      if (url.pathname.startsWith('/api/download/')) {
        const obj = await env.MY_BUCKET.get(decodeURIComponent(url.pathname.slice(14)));
        if(!obj) return new Response('404', { status: 404 });
        const h = new Headers(); obj.writeHttpMetadata(h); h.set('Content-Disposition', `attachment; filename*=UTF-8''${encodeURIComponent(obj.key.split('/').pop())}`);
        return new Response(obj.body, { headers: h });
      }
      if (url.pathname.startsWith('/api/share/')) {
        const obj = await env.MY_BUCKET.get(decodeURIComponent(url.pathname.slice(11)));
        if(!obj) return new Response('404', { status: 404 });
        const h = new Headers(); 
        obj.writeHttpMetadata(h);
        h.set('Content-Type', 'text/plain; charset=utf-8'); 
        h.set('Content-Disposition', 'inline'); 
        return new Response(obj.body, { headers: h });
      }
      if (url.pathname.startsWith('/api/put/')) {
        if(request.method !== 'POST') return new Response('405', { status: 405 });
        await env.MY_BUCKET.put(decodeURIComponent(url.pathname.slice(9)), request.body, { httpMetadata: { contentType: request.headers.get('Content-Type') || 'application/octet-stream' } });
        return new Response('Saved');
      }
      /* --- Cloud Download Backend --- */
      if (url.pathname === '/api/cloud_download') {
          if(request.method !== 'POST') return new Response('405', { status: 405 });
          const { fileUrl, targetKey } = await request.json();
          try {
              const resp = await fetch(fileUrl);
              if (!resp.ok) return new Response('Source error: ' + resp.status, {status: 502});
              await env.MY_BUCKET.put(targetKey, resp.body);
              return new Response('Done');
          } catch(e) { return new Response(e.message, { status: 500 }); }
      }
      /* --- Multipart Upload Backend --- */
      if (url.pathname === '/api/mp/create') {
          if(request.method !== 'POST') return new Response('405', { status: 405 });
          const key = url.searchParams.get('key');
          const multipart = await env.MY_BUCKET.createMultipartUpload(key);
          return new Response(JSON.stringify({ uploadId: multipart.uploadId }), { headers: {'Content-Type': 'application/json'} });
      }
      if (url.pathname === '/api/mp/upload') {
          if(request.method !== 'POST') return new Response('405', { status: 405 });
          const key = url.searchParams.get('key');
          const uploadId = url.searchParams.get('id');
          const partNumber = parseInt(url.searchParams.get('part'));
          const multipart = env.MY_BUCKET.resumeMultipartUpload(key, uploadId);
          const part = await multipart.uploadPart(partNumber, request.body);
          return new Response(JSON.stringify(part), { headers: {'Content-Type': 'application/json'} });
      }
      if (url.pathname === '/api/mp/complete') {
          if(request.method !== 'POST') return new Response('405', { status: 405 });
          const key = url.searchParams.get('key');
          const uploadId = url.searchParams.get('id');
          const { parts } = await request.json();
          const multipart = env.MY_BUCKET.resumeMultipartUpload(key, uploadId);
          await multipart.complete(parts);
          return new Response('Completed');
      }
      /* -------------------------------- */
      if (url.pathname.startsWith('/api/delete/')) {
        if(request.method !== 'DELETE') return new Response('405', { status: 405 });
        await env.MY_BUCKET.delete(decodeURIComponent(url.pathname.slice(12)));
        return new Response('Deleted');
      }
      if (url.pathname === '/api/rename') {
         if(request.method !== 'POST') return new Response('405', { status: 405 });
         const { oldKey, newKey, isFolder } = await request.json();
         try {
             if (isFolder) {
                 let hasMore = true, cursor;
                 while (hasMore) {
                     const list = await env.MY_BUCKET.list({ prefix: oldKey, cursor });
                     for (const obj of list.objects) {
                         const dest = newKey + obj.key.slice(oldKey.length);
                         const src = await env.MY_BUCKET.get(obj.key);
                         await env.MY_BUCKET.put(dest, src.body, { httpMetadata: src.httpMetadata, customMetadata: src.customMetadata });
                         await env.MY_BUCKET.delete(obj.key);
                     }
                     hasMore = list.truncated; cursor = list.cursor;
                 }
             } else {
                 const src = await env.MY_BUCKET.get(oldKey);
                 if(!src) return new Response('404', { status: 404 });
                 await env.MY_BUCKET.put(newKey, src.body, { httpMetadata: src.httpMetadata, customMetadata: src.customMetadata });
                 await env.MY_BUCKET.delete(oldKey);
             }
             return new Response('Renamed');
         } catch (e) { return new Response(e.message, { status: 500 }); }
      }
      if (url.pathname === '/api/copy') {
         if(request.method !== 'POST') return new Response('405', { status: 405 });
         const { srcKey, destKey, isFolder } = await request.json();
         try {
             if (isFolder) {
                 let hasMore = true, cursor;
                 while (hasMore) {
                     const list = await env.MY_BUCKET.list({ prefix: srcKey, cursor });
                     for (const obj of list.objects) {
                         const dest = destKey + obj.key.slice(srcKey.length);
                         const src = await env.MY_BUCKET.get(obj.key);
                         await env.MY_BUCKET.put(dest, src.body, { httpMetadata: src.httpMetadata, customMetadata: src.customMetadata });
                     }
                     hasMore = list.truncated; cursor = list.cursor;
                 }
             } else {
                 const src = await env.MY_BUCKET.get(srcKey);
                 if(!src) return new Response('404', { status: 404 });
                 await env.MY_BUCKET.put(destKey, src.body, { httpMetadata: src.httpMetadata, customMetadata: src.customMetadata });
             }
             return new Response('Copied');
         } catch (e) { return new Response(e.message, { status: 500 }); }
      }
      if (url.pathname.startsWith('/api/delete_folder/')) {
        if(request.method !== 'DELETE') return new Response('405', { status: 405 });
        const prefix = decodeURIComponent(url.pathname.slice(19));
        const list = await env.MY_BUCKET.list({ prefix });
        if(list.objects.length) await env.MY_BUCKET.delete(list.objects.map(o => o.key));
        return new Response('Folder Deleted');
      }
      return new Response('404', { status: 404 });
    }
  };
